---
title: 使用 Azure 和 Azure Stack Hub 的高可用性 Kubernetes 模式
description: 了解 Kubernetes Cluster 解決方案如何使用 Azure 和 Azure Stack Hub 提供高可用性。
author: BryanLa
ms.topic: article
ms.date: 12/03/2020
ms.author: bryanla
ms.reviewer: bryanla
ms.lastreviewed: 12/03/2020
ms.openlocfilehash: 454cc0a0531882b7a8ec050a461420ce13eebcfe
ms.sourcegitcommit: df7e3e6423c3d4e8a42dae3d1acfba1d55057258
ms.translationtype: HT
ms.contentlocale: zh-TW
ms.lasthandoff: 12/09/2020
ms.locfileid: "96911999"
---
# <a name="high-availability-kubernetes-cluster-pattern"></a><span data-ttu-id="cbc14-103">高可用性 Kubernetes 叢集模式</span><span class="sxs-lookup"><span data-stu-id="cbc14-103">High availability Kubernetes cluster pattern</span></span>

<span data-ttu-id="cbc14-104">本文說明如何使用 Azure Stack Hub 上的 Azure Kubernetes Service (AKS) 引擎來建構和操作高可用性的 Kubernetes 式基礎結構。</span><span class="sxs-lookup"><span data-stu-id="cbc14-104">This article describes how to architect and operate a highly available Kubernetes-based infrastructure using Azure Kubernetes Service (AKS) Engine on Azure Stack Hub.</span></span> <span data-ttu-id="cbc14-105">適用此案例的組織通常具有極重要的工作負載，且處在高度受限及受管制的環境中。</span><span class="sxs-lookup"><span data-stu-id="cbc14-105">This scenario is common for organizations with critical workloads in highly restricted and regulated environments.</span></span> <span data-ttu-id="cbc14-106">例如財務、國防和政府領域中的組織。</span><span class="sxs-lookup"><span data-stu-id="cbc14-106">Organizations in domains such as finance, defense, and government.</span></span>

## <a name="context-and-problem"></a><span data-ttu-id="cbc14-107">內容和問題</span><span class="sxs-lookup"><span data-stu-id="cbc14-107">Context and problem</span></span>

<span data-ttu-id="cbc14-108">許多組織都正在開發雲端原生解決方案，以運用最先進的服務和技術，例如 Kubernetes。</span><span class="sxs-lookup"><span data-stu-id="cbc14-108">Many organizations are developing cloud-native solutions that leverage state-of-the-art services and technologies like Kubernetes.</span></span> <span data-ttu-id="cbc14-109">雖然 Azure 在全球大多數區域都提供資料中心，但有時候會有商務關鍵性應用程式必須在特定位置執行的邊緣使用案例和情況。</span><span class="sxs-lookup"><span data-stu-id="cbc14-109">Although Azure provides datacenters in most regions of the world, sometimes there are edge use-cases and scenarios where business critical applications must run in a specific location.</span></span> <span data-ttu-id="cbc14-110">考量項目包括：</span><span class="sxs-lookup"><span data-stu-id="cbc14-110">Considerations include:</span></span>

- <span data-ttu-id="cbc14-111">位置敏感度</span><span class="sxs-lookup"><span data-stu-id="cbc14-111">Location sensitivity</span></span>
- <span data-ttu-id="cbc14-112">應用程式與內部部署系統之間的延遲</span><span class="sxs-lookup"><span data-stu-id="cbc14-112">Latency between the application and on-premises systems</span></span>
- <span data-ttu-id="cbc14-113">頻寬節約</span><span class="sxs-lookup"><span data-stu-id="cbc14-113">Bandwidth conservation</span></span>
- <span data-ttu-id="cbc14-114">連線能力</span><span class="sxs-lookup"><span data-stu-id="cbc14-114">Connectivity</span></span>
- <span data-ttu-id="cbc14-115">法規或法定需求</span><span class="sxs-lookup"><span data-stu-id="cbc14-115">Regulatory or statutory requirements</span></span>

<span data-ttu-id="cbc14-116">Azure 與 Azure Stack Hub 結合可解決大部分的疑慮。</span><span class="sxs-lookup"><span data-stu-id="cbc14-116">Azure, in combination with Azure Stack Hub, addresses most of these concerns.</span></span> <span data-ttu-id="cbc14-117">以下說明在 Azure Stack Hub 上成功實作 Kubernetes 的一組廣泛選項、決策及考量。</span><span class="sxs-lookup"><span data-stu-id="cbc14-117">A broad set of options, decisions, and considerations for a successful implementation of Kubernetes running on Azure Stack Hub is described below.</span></span>

## <a name="solution"></a><span data-ttu-id="cbc14-118">解決方案</span><span class="sxs-lookup"><span data-stu-id="cbc14-118">Solution</span></span>

<span data-ttu-id="cbc14-119">此模式假設我們必須處理一組嚴格的條件約束。</span><span class="sxs-lookup"><span data-stu-id="cbc14-119">This pattern assumes that we have to deal with a strict set of constraints.</span></span> <span data-ttu-id="cbc14-120">應用程式必須在內部部署環境中執行，而且所有個人資料都不得連線到公用雲端服務。</span><span class="sxs-lookup"><span data-stu-id="cbc14-120">The application must run on-premises and all personal data must not reach public cloud services.</span></span> <span data-ttu-id="cbc14-121">監視資料和其他非 PII 資料可以傳送至 Azure，並在該處進行處理。</span><span class="sxs-lookup"><span data-stu-id="cbc14-121">Monitoring and other non-PII data can be sent to Azure and be processed there.</span></span> <span data-ttu-id="cbc14-122">可以存取外部服務 (例如公用 Container Registry 或其他服務)，但可能會透過防火牆或 Proxy 伺服器進行篩選。</span><span class="sxs-lookup"><span data-stu-id="cbc14-122">External services like a public Container Registry or others can be accessed but might be filtered through a firewall or proxy server.</span></span>

<span data-ttu-id="cbc14-123">此處顯示的範例應用程式 (以 [Azure Kubernetes Service 工作坊](/learn/modules/aks-workshop/)為基礎) 已設計為盡可能使用 Kubernetes 原生解決方案。</span><span class="sxs-lookup"><span data-stu-id="cbc14-123">The sample application shown here (based on [Azure Kubernetes Service Workshop](/learn/modules/aks-workshop/)) is designed to use Kubernetes-native solutions whenever possible.</span></span> <span data-ttu-id="cbc14-124">比起使用平台原生服務，此設計可避免廠商鎖定。</span><span class="sxs-lookup"><span data-stu-id="cbc14-124">This design avoids vendor lock-in, instead of using platform-native services.</span></span> <span data-ttu-id="cbc14-125">例如，應用程式會使用自我裝載的 MongoDB 資料庫後端，而不是 PaaS 服務或外部資料庫服務。</span><span class="sxs-lookup"><span data-stu-id="cbc14-125">As an example, the application uses a self-hosted MongoDB database backend instead of a PaaS service or external database service.</span></span>

<span data-ttu-id="cbc14-126">[![混合的應用程式模式](media/pattern-highly-available-kubernetes/application-architecture.png)](media/pattern-highly-available-kubernetes/application-architecture.png#lightbox)</span><span class="sxs-lookup"><span data-stu-id="cbc14-126">[![Application Pattern Hybrid](media/pattern-highly-available-kubernetes/application-architecture.png)](media/pattern-highly-available-kubernetes/application-architecture.png#lightbox)</span></span>

<span data-ttu-id="cbc14-127">上圖說明 Azure Stack Hub 中範例應用程式執行於 Kubernetes 時的應用程式架構。</span><span class="sxs-lookup"><span data-stu-id="cbc14-127">The preceding diagram illustrates the application architecture of the sample application running on Kubernetes on Azure Stack Hub.</span></span> <span data-ttu-id="cbc14-128">應用程式是由數個元件所組成，包括：</span><span class="sxs-lookup"><span data-stu-id="cbc14-128">The app consists of several components, including:</span></span>

 1) <span data-ttu-id="cbc14-129">Azure Stack Hub 上以 AKS 引擎為基礎的 Kubernetes 叢集。</span><span class="sxs-lookup"><span data-stu-id="cbc14-129">An AKS Engine based Kubernetes cluster on Azure Stack Hub.</span></span>
 2) <span data-ttu-id="cbc14-130">[cert-manager](https://www.jetstack.io/cert-manager/)，這會在 Kubernetes 中提供一套憑證管理工具套件，用來自動向 Let's Encrypt 要求憑證。</span><span class="sxs-lookup"><span data-stu-id="cbc14-130">[cert-manager](https://www.jetstack.io/cert-manager/), which provides a suite of tools for certificate management in Kubernetes, used to automatically request certificates from Let's Encrypt.</span></span>
 3) <span data-ttu-id="cbc14-131">Kubernetes 命名空間，其中包含前端 (ratings-web)、API (ratings-api) 和資料庫 (ratings-mongodb) 的應用程式元件。</span><span class="sxs-lookup"><span data-stu-id="cbc14-131">A Kubernetes namespace that contains the application components for the front end (ratings-web), api (ratings-api), and database (ratings-mongodb).</span></span>
 4) <span data-ttu-id="cbc14-132">將 HTTP/HTTPS 流量路由至 Kubernetes 叢集中端點的輸入控制器。</span><span class="sxs-lookup"><span data-stu-id="cbc14-132">The Ingress Controller that routes HTTP/HTTPS traffic to endpoints within the Kubernetes cluster.</span></span>

<span data-ttu-id="cbc14-133">範例應用程式的用途是說明應用程式架構。</span><span class="sxs-lookup"><span data-stu-id="cbc14-133">The sample application is used to illustrate the application architecture.</span></span> <span data-ttu-id="cbc14-134">所有元件都是範例。</span><span class="sxs-lookup"><span data-stu-id="cbc14-134">All components are examples.</span></span> <span data-ttu-id="cbc14-135">此架構僅包含單一應用程式部署。</span><span class="sxs-lookup"><span data-stu-id="cbc14-135">The architecture contains only a single application deployment.</span></span> <span data-ttu-id="cbc14-136">為了達到高可用性 (HA)，我們會在兩個不同的 Azure Stack Hub 執行個體上執行部署至少兩次 (可以在相同位置或兩個以上不同的網站中執行)：</span><span class="sxs-lookup"><span data-stu-id="cbc14-136">To achieve high availability (HA), we'll run the deployment at least twice on two different Azure Stack Hub instances - they can run either in the same location or in two (or more) different sites:</span></span>

![基礎結構架構](media/pattern-highly-available-kubernetes/aks-azure-architecture.png)

<span data-ttu-id="cbc14-138">Azure Container Registry、Azure 監視器及其他等服務都會裝載在 Azure 或內部部署的 Azure Stack Hub 外部。</span><span class="sxs-lookup"><span data-stu-id="cbc14-138">Services like Azure Container Registry, Azure Monitor, and others, are hosted outside Azure Stack Hub in Azure or on-premises.</span></span> <span data-ttu-id="cbc14-139">此混合式設計可防止解決方案發生單一 Azure Stack Hub 執行個體中斷的情況。</span><span class="sxs-lookup"><span data-stu-id="cbc14-139">This hybrid design protects the solution against outage of a single Azure Stack Hub instance.</span></span>

## <a name="components"></a><span data-ttu-id="cbc14-140">元件</span><span class="sxs-lookup"><span data-stu-id="cbc14-140">Components</span></span>

<span data-ttu-id="cbc14-141">整體架構是由下列元件組成：</span><span class="sxs-lookup"><span data-stu-id="cbc14-141">The overall architecture consists of the following components:</span></span>

<span data-ttu-id="cbc14-142">**Azure Stack Hub** 是 Azure 的一項擴充功能，可在資料中心提供 Azure 服務，以便您在內部部署環境中執行應用程式。</span><span class="sxs-lookup"><span data-stu-id="cbc14-142">**Azure Stack Hub** is an extension of Azure that can run workloads in an on-premises environment by providing Azure services in your datacenter.</span></span> <span data-ttu-id="cbc14-143">請移至 [Azure Stack Hub 概觀](/azure-stack/operator/azure-stack-overview)以深入了解。</span><span class="sxs-lookup"><span data-stu-id="cbc14-143">Go to [Azure Stack Hub overview](/azure-stack/operator/azure-stack-overview) to learn more.</span></span>

<span data-ttu-id="cbc14-144">**Azure Kubernetes Service 引擎 (AKS 引擎)** 是受控 Kubernetes 服務供應項目 Azure Kubernetes Service (AKS) 背後的引擎，目前已可在 Azure 中使用。</span><span class="sxs-lookup"><span data-stu-id="cbc14-144">**Azure Kubernetes Service Engine (AKS Engine)** is the engine behind the managed Kubernetes service offering, Azure Kubernetes Service (AKS), that is available in Azure today.</span></span> <span data-ttu-id="cbc14-145">針對 Azure Stack Hub，AKS 引擎可讓我們使用 Azure Stack Hub 的 IaaS 功能來部署、調整和升級功能完整且自我管理的 Kubernetes 叢集。</span><span class="sxs-lookup"><span data-stu-id="cbc14-145">For Azure Stack Hub, AKS Engine allows us to deploy, scale, and upgrade fully featured, self-managed Kubernetes clusters using Azure Stack Hub's IaaS capabilities.</span></span> <span data-ttu-id="cbc14-146">若要深入了解，請移至 [AKS 引擎概觀](https://github.com/Azure/aks-engine)。</span><span class="sxs-lookup"><span data-stu-id="cbc14-146">Go to [AKS Engine Overview](https://github.com/Azure/aks-engine) to learn more.</span></span>

<span data-ttu-id="cbc14-147">若要深入了解 Azure 上的 AKS 引擎與 Azure Stack Hub 上的 AKS Engine 之間有何差異，請移至[已知問題和限制](https://github.com/Azure/aks-engine/blob/master/docs/topics/azure-stack.md#known-issues-and-limitations)。</span><span class="sxs-lookup"><span data-stu-id="cbc14-147">Go to [Known Issues and Limitations](https://github.com/Azure/aks-engine/blob/master/docs/topics/azure-stack.md#known-issues-and-limitations) to learn more about the differences between AKS Engine on Azure and AKS Engine on Azure Stack Hub.</span></span>

<span data-ttu-id="cbc14-148">針對裝載 Kubernetes 叢集基礎結構的虛擬機器 (VM)，**Azure 虛擬網路 (VNet)** 可用來為其中每個 Azure Stack Hub 提供網路基礎結構。</span><span class="sxs-lookup"><span data-stu-id="cbc14-148">**Azure Virtual Network (VNet)** is used to provide the network infrastructure on each Azure Stack Hub for the Virtual Machines (VMs) hosting the Kubernetes cluster infrastructure.</span></span>

<span data-ttu-id="cbc14-149">Kubernetes API 端點和 Nginx 輸入控制器會使用 **Azure Load Balancer**。</span><span class="sxs-lookup"><span data-stu-id="cbc14-149">**Azure Load Balancer** is used for the Kubernetes API Endpoint and the Nginx Ingress Controller.</span></span> <span data-ttu-id="cbc14-150">此負載平衡器會將外部 (例如網際網路) 流量路由至提供特定服務的節點和 VM。</span><span class="sxs-lookup"><span data-stu-id="cbc14-150">The load balancer routes external (for example, Internet) traffic to nodes and VMs offering a specific service.</span></span>

<span data-ttu-id="cbc14-151">**Azure Container Registry (ACR)** 會用來儲存私人 Docker 映像，以及部署至叢集的 Helm 圖表。</span><span class="sxs-lookup"><span data-stu-id="cbc14-151">**Azure Container Registry (ACR)** is used to store private Docker images and Helm charts, which are deployed to the cluster.</span></span> <span data-ttu-id="cbc14-152">AKS 引擎可以使用 Azure AD 身分識別向 Container Registry 進行驗證。</span><span class="sxs-lookup"><span data-stu-id="cbc14-152">AKS Engine can authenticate with the Container Registry using an Azure AD identity.</span></span> <span data-ttu-id="cbc14-153">Kubernetes 不需要 ACR。</span><span class="sxs-lookup"><span data-stu-id="cbc14-153">Kubernetes doesn't require ACR.</span></span> <span data-ttu-id="cbc14-154">您可以使用其他容器登錄，例如 Docker Hub。</span><span class="sxs-lookup"><span data-stu-id="cbc14-154">You can use other container registries, such as Docker Hub.</span></span>

<span data-ttu-id="cbc14-155">**Azure Repos** 是一組版本控制工具，可用來管理程式碼。</span><span class="sxs-lookup"><span data-stu-id="cbc14-155">**Azure Repos** is a set of version control tools that you can use to manage your code.</span></span> <span data-ttu-id="cbc14-156">您也可以使用 GitHub 或其他以 git 為基礎的存放庫。</span><span class="sxs-lookup"><span data-stu-id="cbc14-156">You can also use GitHub or other git-based repositories.</span></span> <span data-ttu-id="cbc14-157">若要深入了解，請移至 [Azure Repos 概觀](/azure/devops/repos/get-started/what-is-repos)。</span><span class="sxs-lookup"><span data-stu-id="cbc14-157">Go to [Azure Repos Overview](/azure/devops/repos/get-started/what-is-repos) to learn more.</span></span>

<span data-ttu-id="cbc14-158">**Azure Pipelines** 是 Azure DevOps Services 的一部分，可執行自動化組建、測試及部署。</span><span class="sxs-lookup"><span data-stu-id="cbc14-158">**Azure Pipelines** is part of Azure DevOps Services and runs automated builds, tests, and deployments.</span></span> <span data-ttu-id="cbc14-159">您也可以使用 Jenkins 等第三方 CI/CD 解決方案。</span><span class="sxs-lookup"><span data-stu-id="cbc14-159">You can also use third-party CI/CD solutions such as Jenkins.</span></span> <span data-ttu-id="cbc14-160">若要深入了解，請移至 [Azure Pipeline 概觀](/azure/devops/pipelines/get-started/what-is-azure-pipelines)。</span><span class="sxs-lookup"><span data-stu-id="cbc14-160">Go to [Azure Pipeline Overview](/azure/devops/pipelines/get-started/what-is-azure-pipelines) to learn more.</span></span>

<span data-ttu-id="cbc14-161">**Azure 監視器** 會收集並儲存計量和記錄，包括解決方案中 Azure 服務的平台計量和應用程式遙測。</span><span class="sxs-lookup"><span data-stu-id="cbc14-161">**Azure Monitor** collects and stores metrics and logs, including platform metrics for the Azure services in the solution and application telemetry.</span></span> <span data-ttu-id="cbc14-162">您可以使用此資料來監視應用程式、設定警示和儀表板，以及對失敗執行根本原因分析。</span><span class="sxs-lookup"><span data-stu-id="cbc14-162">Use this data to monitor the application, set up alerts and dashboards, and perform root cause analysis of failures.</span></span> <span data-ttu-id="cbc14-163">Azure 監視器會與 Kubernetes 整合，以收集控制器、節點和容器中的計量，以及容器記錄和主要節點記錄。</span><span class="sxs-lookup"><span data-stu-id="cbc14-163">Azure Monitor integrates with Kubernetes to collect metrics from controllers, nodes, and containers, as well as container logs and master node logs.</span></span> <span data-ttu-id="cbc14-164">若要深入了解，請移至 [Azure 監視器概觀](/azure/azure-monitor/overview)。</span><span class="sxs-lookup"><span data-stu-id="cbc14-164">Go to [Azure Monitor Overview](/azure/azure-monitor/overview) to learn more.</span></span>

<span data-ttu-id="cbc14-165">**Azure 流量管理員** 是以 DNS 為基礎的流量負載平衡器，可讓您以最佳方式將流量分散到不同 Azure 區域或 Azure Stack Hub 部署上的服務。</span><span class="sxs-lookup"><span data-stu-id="cbc14-165">**Azure Traffic Manager** is a DNS-based traffic load balancer that enables you to distribute traffic optimally to services across different Azure regions or Azure Stack Hub deployments.</span></span> <span data-ttu-id="cbc14-166">流量管理員也會提供高可用性和回應性。</span><span class="sxs-lookup"><span data-stu-id="cbc14-166">Traffic Manager also provides high availability and responsiveness.</span></span> <span data-ttu-id="cbc14-167">應用程式端點必須可從外部存取。</span><span class="sxs-lookup"><span data-stu-id="cbc14-167">The application endpoints must be accessible from the outside.</span></span> <span data-ttu-id="cbc14-168">還有其他內部部署解決方案也可供使用。</span><span class="sxs-lookup"><span data-stu-id="cbc14-168">There are other on-premises solutions available as well.</span></span>

<span data-ttu-id="cbc14-169">**Kubernetes 輸入控制器** 會將 HTTP (S) 路由公開給 Kubernetes 叢集中的服務。</span><span class="sxs-lookup"><span data-stu-id="cbc14-169">**Kubernetes Ingress Controller** exposes HTTP(S) routes to services in a Kubernetes cluster.</span></span> <span data-ttu-id="cbc14-170">Nginx 或任何適當的輸入控制器都可以用於此用途。</span><span class="sxs-lookup"><span data-stu-id="cbc14-170">Nginx or any suitable ingress controller can be used for this purpose.</span></span>

<span data-ttu-id="cbc14-171">**Helm** 是 Kubernetes 部署的套件管理員，可將不同的 Kubernetes 物件 (例如部署、服務、祕密) 組合成單一「圖表」。</span><span class="sxs-lookup"><span data-stu-id="cbc14-171">**Helm** is a package manager for Kubernetes deployment, providing a way to bundle different Kubernetes objects like Deployments, Services, Secrets, into a single "chart".</span></span> <span data-ttu-id="cbc14-172">您可以發行、部署、控制版本管理並更新圖表物件。</span><span class="sxs-lookup"><span data-stu-id="cbc14-172">You can publish, deploy, control version management, and update a chart  object.</span></span> <span data-ttu-id="cbc14-173">Azure Container Registry 可當作存放庫來儲存已封裝的 Helm 圖表。</span><span class="sxs-lookup"><span data-stu-id="cbc14-173">Azure Container Registry can be used as a repository to store packaged Helm Charts.</span></span>

## <a name="design-considerations"></a><span data-ttu-id="cbc14-174">設計考量</span><span class="sxs-lookup"><span data-stu-id="cbc14-174">Design considerations</span></span>

<span data-ttu-id="cbc14-175">此模式會遵循一些高階考量，本文的後續章節中會有更詳細的說明：</span><span class="sxs-lookup"><span data-stu-id="cbc14-175">This pattern follows a few high-level considerations explained in more detail in the next sections of this article:</span></span>

- <span data-ttu-id="cbc14-176">應用程式會使用 Kubernetes 原生解決方案，以避免廠商鎖定。</span><span class="sxs-lookup"><span data-stu-id="cbc14-176">The application uses Kubernetes-native solutions, to avoid vendor lock-in.</span></span>
- <span data-ttu-id="cbc14-177">應用程式會使用微服務架構。</span><span class="sxs-lookup"><span data-stu-id="cbc14-177">The application uses a microservices architecture.</span></span>
- <span data-ttu-id="cbc14-178">Azure Stack Hub 不需要輸入連線，但允許輸出網際網路連線。</span><span class="sxs-lookup"><span data-stu-id="cbc14-178">Azure Stack Hub doesn't need inbound but allows outbound Internet connectivity.</span></span>

<span data-ttu-id="cbc14-179">這些建議的作法也適用於真實世界的工作負載和案例。</span><span class="sxs-lookup"><span data-stu-id="cbc14-179">These recommended practices will apply to real-world workloads and scenarios as well.</span></span>

## <a name="scalability-considerations"></a><span data-ttu-id="cbc14-180">延展性考量</span><span class="sxs-lookup"><span data-stu-id="cbc14-180">Scalability considerations</span></span>

<span data-ttu-id="cbc14-181">可擴縮性非常重要，因為要為使用者提供一致、可靠且高效能的應用程式存取。</span><span class="sxs-lookup"><span data-stu-id="cbc14-181">Scalability is important to provide users consistent, reliable, and well-performing access to the application.</span></span>

<span data-ttu-id="cbc14-182">範例案例涵蓋應用程式堆疊的多層次可擴縮性。</span><span class="sxs-lookup"><span data-stu-id="cbc14-182">The sample scenario covers scalability on multiple layers of the application stack.</span></span> <span data-ttu-id="cbc14-183">以下是不同等級的高階概觀：</span><span class="sxs-lookup"><span data-stu-id="cbc14-183">Here's a high-level overview of the different layers:</span></span>

| <span data-ttu-id="cbc14-184">架構層級</span><span class="sxs-lookup"><span data-stu-id="cbc14-184">Architecture level</span></span> | <span data-ttu-id="cbc14-185">影響</span><span class="sxs-lookup"><span data-stu-id="cbc14-185">Affects</span></span> | <span data-ttu-id="cbc14-186">怎麼做？</span><span class="sxs-lookup"><span data-stu-id="cbc14-186">How?</span></span> |
| --- | --- | ---
| <span data-ttu-id="cbc14-187">應用程式</span><span class="sxs-lookup"><span data-stu-id="cbc14-187">Application</span></span> | <span data-ttu-id="cbc14-188">應用程式</span><span class="sxs-lookup"><span data-stu-id="cbc14-188">Application</span></span> | <span data-ttu-id="cbc14-189">根據 Pod/複本/容器實執行個體的數目進行水平調整\*</span><span class="sxs-lookup"><span data-stu-id="cbc14-189">Horizontal scaling based on the number of Pods/Replicas/Container Instances\*</span></span> |
| <span data-ttu-id="cbc14-190">叢集</span><span class="sxs-lookup"><span data-stu-id="cbc14-190">Cluster</span></span> | <span data-ttu-id="cbc14-191">Kubernetes 叢集</span><span class="sxs-lookup"><span data-stu-id="cbc14-191">Kubernetes cluster</span></span> | <span data-ttu-id="cbc14-192">節點數目 (介於 1 到 50)、VM SKU 大小和節點集區 (Azure Stack Hub 的 AKS 引擎目前僅支援單一節點集區)；使用 AKS 引擎的調整命令 (手動)</span><span class="sxs-lookup"><span data-stu-id="cbc14-192">Number of Nodes (between 1 and 50), VM-SKU-sizes, and Node Pools (AKS Engine on Azure Stack Hub currently supports only a single node pool); using AKS Engine's scale command (manual)</span></span> |
| <span data-ttu-id="cbc14-193">基礎結構</span><span class="sxs-lookup"><span data-stu-id="cbc14-193">Infrastructure</span></span> | <span data-ttu-id="cbc14-194">Azure Stack Hub</span><span class="sxs-lookup"><span data-stu-id="cbc14-194">Azure Stack Hub</span></span> | <span data-ttu-id="cbc14-195">Azure Stack Hub 部署內的節點數目、容量和縮放單位數目</span><span class="sxs-lookup"><span data-stu-id="cbc14-195">Number of nodes, capacity, and scale units within an Azure Stack Hub deployment</span></span> |

<span data-ttu-id="cbc14-196">\* 使用 Kubernetes 的水平 Pod 自動調整程式 (HPA)；調整容器執行個體的大小 (CPU/記憶體) 可進行自動化的計量式調整或垂直調整。</span><span class="sxs-lookup"><span data-stu-id="cbc14-196">\* Using Kubernetes' Horizontal Pod Autoscaler (HPA); automated metric-based scaling or vertical scaling by sizing the container instances (cpu/memory).</span></span>

<span data-ttu-id="cbc14-197">**Azure Stack Hub (基礎結構層級)**</span><span class="sxs-lookup"><span data-stu-id="cbc14-197">**Azure Stack Hub (infrastructure level)**</span></span>

<span data-ttu-id="cbc14-198">Azure Stack Hub 基礎結構是此實作的基礎，因為 Azure Stack Hub 是在資料中心內的實體硬體上執行。</span><span class="sxs-lookup"><span data-stu-id="cbc14-198">The Azure Stack Hub infrastructure is the foundation of this implementation, because Azure Stack Hub runs on physical hardware in a datacenter.</span></span> <span data-ttu-id="cbc14-199">選取您的 Hub 硬體時，您需要選擇 CPU、記憶體密度、儲存體設定和伺服器數目。</span><span class="sxs-lookup"><span data-stu-id="cbc14-199">When selecting your Hub hardware, you need to make choices for CPU, memory density, storage configuration, and number of servers.</span></span> <span data-ttu-id="cbc14-200">若要深入了解 Azure Stack Hub 的可擴縮性，請參閱下列資源：</span><span class="sxs-lookup"><span data-stu-id="cbc14-200">To learn more about Azure Stack Hub's scalability, check out the following resources:</span></span>

- [<span data-ttu-id="cbc14-201">Azure Stack Hub 的容量規劃概觀</span><span class="sxs-lookup"><span data-stu-id="cbc14-201">Capacity planning for Azure Stack Hub overview</span></span>](/azure-stack/operator/azure-stack-capacity-planning-overview)
- [<span data-ttu-id="cbc14-202">在 Azure Stack Hub 中新增更多縮放單位節點</span><span class="sxs-lookup"><span data-stu-id="cbc14-202">Add additional scale unit nodes in Azure Stack Hub</span></span>](/azure-stack/operator/azure-stack-add-scale-node)

<span data-ttu-id="cbc14-203">**Kubernetes 叢集 (叢集層級)**</span><span class="sxs-lookup"><span data-stu-id="cbc14-203">**Kubernetes cluster (cluster level)**</span></span>

<span data-ttu-id="cbc14-204">Kubernetes 叢集本身包含並以其作為建置基礎的 Azure (Stack) IaaS 元件包括計算、儲存體和網路資源。</span><span class="sxs-lookup"><span data-stu-id="cbc14-204">The Kubernetes cluster itself consists of, and is built on top of Azure (Stack) IaaS components including compute, storage, and network resources.</span></span> <span data-ttu-id="cbc14-205">Kubernetes 解決方案包含主要和背景工作節點，這些都會部署為 Azure (和 Azure Stack Hub) 中的 VM。</span><span class="sxs-lookup"><span data-stu-id="cbc14-205">Kubernetes solutions involve master and worker nodes, which are deployed as VMs in Azure (and Azure Stack Hub).</span></span>

- <span data-ttu-id="cbc14-206">[控制平面節點](/azure/aks/concepts-clusters-workloads#control-plane) (主要) 提供核心 Kubernetes 服務和應用程式工作負載的協調流程。</span><span class="sxs-lookup"><span data-stu-id="cbc14-206">[Control plane nodes](/azure/aks/concepts-clusters-workloads#control-plane) (master) provide the core Kubernetes services and orchestration of application workloads.</span></span>
- <span data-ttu-id="cbc14-207">[背景工作節點](/azure/aks/concepts-clusters-workloads#nodes-and-node-pools) (背景工作角色) 會執行您的應用程式工作負載。</span><span class="sxs-lookup"><span data-stu-id="cbc14-207">[Worker nodes](/azure/aks/concepts-clusters-workloads#nodes-and-node-pools) (worker) run your application workloads.</span></span>

<span data-ttu-id="cbc14-208">選取初始部署的 VM 大小時，有幾個考量點：</span><span class="sxs-lookup"><span data-stu-id="cbc14-208">When selecting VM sizes for the initial deployment, there are several considerations:</span></span>  

- <span data-ttu-id="cbc14-209">**成本** - 規劃背景工作節點時，請注意每個 VM 產生的整體成本。</span><span class="sxs-lookup"><span data-stu-id="cbc14-209">**Cost** - When planning your worker nodes, keep in mind the overall cost per VM you'll incur.</span></span> <span data-ttu-id="cbc14-210">例如，如果您的應用程式工作負載需要的資源有限，您應該規劃部署大小較小的 VM。</span><span class="sxs-lookup"><span data-stu-id="cbc14-210">For example, if your application workloads require limited resources, you should plan to deploy smaller sized VMs.</span></span> <span data-ttu-id="cbc14-211">Azure Stack Hub (例如 Azure) 通常會以耗用量計費，因此適當地調整 Kubernetes 角色的 VM 大小，對於最佳化耗用量成本非常重要。</span><span class="sxs-lookup"><span data-stu-id="cbc14-211">Azure Stack Hub, like Azure, is normally billed on a consumption basis, so appropriately sizing the VMs for Kubernetes roles is crucial to optimizing consumption costs.</span></span> 

- <span data-ttu-id="cbc14-212">**可擴縮性** - 縮減和擴增主要和背景工作節點的數目，或藉由新增其他節點集區，都可完成叢集的擴縮 (目前不適用於 Azure Stack Hub)。</span><span class="sxs-lookup"><span data-stu-id="cbc14-212">**Scalability** - Scalability of the cluster is achieved by scaling in and out the number of master and worker nodes, or by adding additional node pools (not available on Azure Stack Hub today).</span></span> <span data-ttu-id="cbc14-213">調整叢集規模可以根據以容器深入解析 (Azure 監視器 + Log Analytics) 所收集的效能資料來完成。</span><span class="sxs-lookup"><span data-stu-id="cbc14-213">Scaling the cluster can be done based on performance data, collected using Container Insights (Azure Monitor + Log Analytics).</span></span> 

    <span data-ttu-id="cbc14-214">如果您的應用程式需要更多 (或更少) 資源，您可以水平擴增 (或縮減) 您目前的節點 (介於 1 到 50 個節點之間)。</span><span class="sxs-lookup"><span data-stu-id="cbc14-214">If your application needs more (or fewer) resources, you can scale out (or in) your current nodes horizontally (between 1 and 50 nodes).</span></span> <span data-ttu-id="cbc14-215">如果您需要超過 50 個節點，您可以在個別的訂用帳戶中建立額外叢集。</span><span class="sxs-lookup"><span data-stu-id="cbc14-215">If you need more than 50 nodes, you can create an additional cluster in a separate subscription.</span></span> <span data-ttu-id="cbc14-216">若不重新部署叢集，您無法將實際的 VM 垂直擴大為另一個 VM 大小。</span><span class="sxs-lookup"><span data-stu-id="cbc14-216">You can't scale up the actual VMs vertically to another VM size without redeploying the cluster.</span></span>

    <span data-ttu-id="cbc14-217">您可以使用一開始用來部署 Kubernetes 叢集的 AKS 引擎協助程式 VM 來手動調整規模。</span><span class="sxs-lookup"><span data-stu-id="cbc14-217">Scaling is done manually using the AKS Engine helper VM that was used to deploy the Kubernetes cluster initially.</span></span> <span data-ttu-id="cbc14-218">如需詳細資訊，請參閱[調整 Kubernetes 叢集](https://github.com/Azure/aks-engine/blob/master/docs/topics/scale.md)</span><span class="sxs-lookup"><span data-stu-id="cbc14-218">For more information, see [Scaling Kubernetes clusters](https://github.com/Azure/aks-engine/blob/master/docs/topics/scale.md)</span></span>

- <span data-ttu-id="cbc14-219">**配額** - 請考量您在 Azure Stack Hub 上規劃 AKS 部署時所設定的[配額](/azure-stack/operator/azure-stack-quota-types)。</span><span class="sxs-lookup"><span data-stu-id="cbc14-219">**Quotas** - Consider the [quotas](/azure-stack/operator/azure-stack-quota-types) you've configured when planning out an AKS deployment on your Azure Stack Hub.</span></span> <span data-ttu-id="cbc14-220">請確定每個[訂用帳戶](/azure-stack/operator/service-plan-offer-subscription-overview)都已設定適當的方案和配額。</span><span class="sxs-lookup"><span data-stu-id="cbc14-220">Make sure each [subscription](/azure-stack/operator/service-plan-offer-subscription-overview) has the proper plans and the quotas configured.</span></span> <span data-ttu-id="cbc14-221">擴增叢集時，訂用帳戶必須可容納您叢集所需的計算、儲存體和其他服務數量。</span><span class="sxs-lookup"><span data-stu-id="cbc14-221">The subscription will need to accommodate the amount of compute, storage, and other services needed for your clusters as they scale out.</span></span>

- <span data-ttu-id="cbc14-222">**應用程式工作負載** - 請在 Azure Kubernetes Service 文件的 Kubernetes 核心概念中參閱＜[叢集和工作負載概念](/azure/aks/concepts-clusters-workloads#nodes-and-node-pools)＞。</span><span class="sxs-lookup"><span data-stu-id="cbc14-222">**Application workloads** - Refer to the [Clusters and workloads concepts](/azure/aks/concepts-clusters-workloads#nodes-and-node-pools) in the Kubernetes core concepts for Azure Kubernetes Service document.</span></span> <span data-ttu-id="cbc14-223">本文將協助您根據應用程式的計算和記憶體需求來界定適當的 VM 大小範圍。</span><span class="sxs-lookup"><span data-stu-id="cbc14-223">This article will help you scope the proper VM size based on the compute and memory needs of your application.</span></span>  

<span data-ttu-id="cbc14-224">**應用程式 (應用程式層級)**</span><span class="sxs-lookup"><span data-stu-id="cbc14-224">**Application (application level)**</span></span>

<span data-ttu-id="cbc14-225">在應用程式層次中，我們使用了 Kubernetes [水平 Pod 自動調整程式 (HPA)](https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/)。</span><span class="sxs-lookup"><span data-stu-id="cbc14-225">On the application layer, we use Kubernetes [Horizontal Pod Autoscaler (HPA)](https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/).</span></span> <span data-ttu-id="cbc14-226">HPA 可以根據不同的計量 (例如 CPU 使用率) 來增加或減少部署中的複本數目 (Pod/容器執行個體)。</span><span class="sxs-lookup"><span data-stu-id="cbc14-226">HPA can increase or decrease the number of Replicas (Pod/Container Instances) in our deployment based on different metrics (like CPU utilization).</span></span>

<span data-ttu-id="cbc14-227">另一個選項是垂直調整容器執行個體的規模。</span><span class="sxs-lookup"><span data-stu-id="cbc14-227">Another option is to scale container instances vertically.</span></span> <span data-ttu-id="cbc14-228">這可以藉由變更要求的 CPU 和記憶體數量，以及特定部署的可用空間來完成。</span><span class="sxs-lookup"><span data-stu-id="cbc14-228">This can be accomplished by changing the amount of CPU and Memory requested and available for a specific deployment.</span></span> <span data-ttu-id="cbc14-229">若要深入了解，請參閱 kubernetes.io 上的[管理容器資源](https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/)。</span><span class="sxs-lookup"><span data-stu-id="cbc14-229">See [Managing Resources for Containers](https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/) on kubernetes.io to learn more.</span></span>

## <a name="networking-and-connectivity-considerations"></a><span data-ttu-id="cbc14-230">網路功能和連線能力的考量</span><span class="sxs-lookup"><span data-stu-id="cbc14-230">Networking and connectivity considerations</span></span>

<span data-ttu-id="cbc14-231">針對 Azure Stack Hub 上的 Kubernetes，網路功能和連線能力也會影響先前所述的三個層級。</span><span class="sxs-lookup"><span data-stu-id="cbc14-231">Networking and connectivity also affect the three layers mentioned previously for Kubernetes on Azure Stack Hub.</span></span> <span data-ttu-id="cbc14-232">下表顯示各層次及其包含的服務：</span><span class="sxs-lookup"><span data-stu-id="cbc14-232">The following table shows the layers and which services they contain:</span></span>

| <span data-ttu-id="cbc14-233">層</span><span class="sxs-lookup"><span data-stu-id="cbc14-233">Layer</span></span> | <span data-ttu-id="cbc14-234">影響</span><span class="sxs-lookup"><span data-stu-id="cbc14-234">Affects</span></span> | <span data-ttu-id="cbc14-235">何事？</span><span class="sxs-lookup"><span data-stu-id="cbc14-235">What?</span></span> |
| --- | --- | ---
| <span data-ttu-id="cbc14-236">應用程式</span><span class="sxs-lookup"><span data-stu-id="cbc14-236">Application</span></span> | <span data-ttu-id="cbc14-237">應用程式</span><span class="sxs-lookup"><span data-stu-id="cbc14-237">Application</span></span> | <span data-ttu-id="cbc14-238">如何存取應用程式？</span><span class="sxs-lookup"><span data-stu-id="cbc14-238">How is the application accessible?</span></span> <span data-ttu-id="cbc14-239">是否會公開至網際網路？</span><span class="sxs-lookup"><span data-stu-id="cbc14-239">Will it be exposed to the Internet?</span></span> |
| <span data-ttu-id="cbc14-240">叢集</span><span class="sxs-lookup"><span data-stu-id="cbc14-240">Cluster</span></span> | <span data-ttu-id="cbc14-241">Kubernetes 叢集</span><span class="sxs-lookup"><span data-stu-id="cbc14-241">Kubernetes cluster</span></span> | <span data-ttu-id="cbc14-242">Kubernetes API、AKS 引擎 VM、提取容器映像 (輸出)、傳送監視資料和遙測 (輸出)</span><span class="sxs-lookup"><span data-stu-id="cbc14-242">Kubernetes API, AKS Engine VM, Pulling container images (egress), Sending monitoring data and telemetry (egress)</span></span> |
| <span data-ttu-id="cbc14-243">基礎結構</span><span class="sxs-lookup"><span data-stu-id="cbc14-243">Infrastructure</span></span> | <span data-ttu-id="cbc14-244">Azure Stack Hub</span><span class="sxs-lookup"><span data-stu-id="cbc14-244">Azure Stack Hub</span></span> | <span data-ttu-id="cbc14-245">Azure Stack Hub 管理端點 (例如入口網站和 Azure Resource Manager 端點) 的可存取性。</span><span class="sxs-lookup"><span data-stu-id="cbc14-245">Accessibility of the Azure Stack Hub management endpoints like the portal and Azure Resource Manager endpoints.</span></span> |

<span data-ttu-id="cbc14-246">**應用程式**</span><span class="sxs-lookup"><span data-stu-id="cbc14-246">**Application**</span></span>

<span data-ttu-id="cbc14-247">對於應用程式層，最重要的考量是應用程式是否公開，以及是否可從網際網路存取。</span><span class="sxs-lookup"><span data-stu-id="cbc14-247">For the application layer, the most important consideration is whether the application is exposed and accessible from the Internet.</span></span> <span data-ttu-id="cbc14-248">從 Kubernetes 的觀點來看，網際網路的可存取性代表著使用 Kubernetes 服務或輸入控制器來公開部署或 Pod。</span><span class="sxs-lookup"><span data-stu-id="cbc14-248">From a Kubernetes perspective, Internet accessibility means exposing a deployment or pod using a Kubernetes Service or an Ingress Controller.</span></span>

> [!NOTE]
> <span data-ttu-id="cbc14-249">我們建議使用輸入控制器來公開 Kubernetes 服務，因為 Azure Stack Hub 上的前端公用 IP 數目會限制為 5 個。</span><span class="sxs-lookup"><span data-stu-id="cbc14-249">We recommend the use of Ingress controllers to expose Kubernetes Services as the number of Frontend public IPs on Azure Stack Hub is limited to 5.</span></span> <span data-ttu-id="cbc14-250">此設計也會將 Kubernetes 服務 (類型為 LoadBalancer) 的數目限制為 5 個，而這對許多部署而言太小。</span><span class="sxs-lookup"><span data-stu-id="cbc14-250">This design also limits the number of Kubernetes Services (with the type LoadBalancer) to 5, which will be too small for many deployments.</span></span> <span data-ttu-id="cbc14-251">若要深入了解，請移至 [AKS 引擎文件](https://github.com/Azure/aks-engine/blob/master/docs/topics/azure-stack.md#limited-number-of-frontend-public-ips)。</span><span class="sxs-lookup"><span data-stu-id="cbc14-251">Go to the [AKS Engine documentation](https://github.com/Azure/aks-engine/blob/master/docs/topics/azure-stack.md#limited-number-of-frontend-public-ips) to learn more.</span></span>

<span data-ttu-id="cbc14-252">透過 Load Balancer 或輸入控制器使用公用 IP 來公開應用程式，並不一定表示應用程式現在可以透過網際網路存取。</span><span class="sxs-lookup"><span data-stu-id="cbc14-252">Exposing an application using a public IP via a Load Balancer or an Ingress Controller doesn't nessecarily mean that the application is now accessible via the Internet.</span></span> <span data-ttu-id="cbc14-253">Azure Stack Hub 具有的公用 IP 位址可能只會顯示在本地的內部網路上，並非所有公用 IP 都是真正地公開於網際網路。</span><span class="sxs-lookup"><span data-stu-id="cbc14-253">It's possible for Azure Stack Hub to have a public IP address that is only visible on the local intranet - not all public IPs are truly Internet-facing.</span></span>

<span data-ttu-id="cbc14-254">先前的區塊考量到應用程式的輸入流量。</span><span class="sxs-lookup"><span data-stu-id="cbc14-254">The previous block considers ingress traffic to the application.</span></span> <span data-ttu-id="cbc14-255">要成功部署 Kubernetes 的另一個必須考量的主題是輸出流量。</span><span class="sxs-lookup"><span data-stu-id="cbc14-255">Another topic that must be considered for a successful Kubernetes deployment is outbound/egress traffic.</span></span> <span data-ttu-id="cbc14-256">以下是幾個需要輸出流量的使用案例：</span><span class="sxs-lookup"><span data-stu-id="cbc14-256">Here are a few use cases that require egress traffic:</span></span>

- <span data-ttu-id="cbc14-257">提取儲存 DockerHub 或 Azure Container Registry 上儲存的容器映像</span><span class="sxs-lookup"><span data-stu-id="cbc14-257">Pulling Container Images stored on DockerHub or Azure Container Registry</span></span>
- <span data-ttu-id="cbc14-258">擷取 Helm 圖表</span><span class="sxs-lookup"><span data-stu-id="cbc14-258">Retrieving Helm Charts</span></span>
- <span data-ttu-id="cbc14-259">發出 Application Insights 資料 (或其他監視資料)</span><span class="sxs-lookup"><span data-stu-id="cbc14-259">Emitting Application Insights data (or other monitoring data)</span></span>

<span data-ttu-id="cbc14-260">某些企業環境可能需要使用「透明」或「非透明」的 Proxy 伺服器。</span><span class="sxs-lookup"><span data-stu-id="cbc14-260">Some enterprise environments might require the use of _transparent_ or _non-transparent_ proxy servers.</span></span> <span data-ttu-id="cbc14-261">這些伺服器需要在叢集的各種元件上進行特定設定。</span><span class="sxs-lookup"><span data-stu-id="cbc14-261">These servers require specific configuration on various components of our cluster.</span></span> <span data-ttu-id="cbc14-262">AKS 引擎文件包含有關如何配合網路 Proxy 的各種詳細資料。</span><span class="sxs-lookup"><span data-stu-id="cbc14-262">The AKS Engine documentation contains various details on how to accommodate network proxies.</span></span> <span data-ttu-id="cbc14-263">如需詳細資訊，請參閱 [AKS 引擎和 Proxy 伺服器](https://github.com/Azure/aks-engine/blob/master/docs/topics/proxy-servers.md)</span><span class="sxs-lookup"><span data-stu-id="cbc14-263">For more details, see [AKS Engine and proxy servers](https://github.com/Azure/aks-engine/blob/master/docs/topics/proxy-servers.md)</span></span>

<span data-ttu-id="cbc14-264">最後，跨叢集流量必須在 Azure Stack Hub 執行個體之間流動。</span><span class="sxs-lookup"><span data-stu-id="cbc14-264">Lastly, cross-cluster traffic must flow between Azure Stack Hub instances.</span></span> <span data-ttu-id="cbc14-265">範例部署是由個別 Azure Stack Hub 執行個體上執行的個別 Kubernetes 叢集所組成。</span><span class="sxs-lookup"><span data-stu-id="cbc14-265">The sample deployment consists of individual Kubernetes clusters running on individual Azure Stack Hub instances.</span></span> <span data-ttu-id="cbc14-266">其間的流量 (例如兩個資料庫之間的複寫流量) 是「外部流量」。</span><span class="sxs-lookup"><span data-stu-id="cbc14-266">Traffic between them, such as the replication traffic between two databases, is "external traffic".</span></span> <span data-ttu-id="cbc14-267">外部流量必須透過站對站 VPN 或 Azure Stack Hub 公用 IP 位址來進行路由，才能連結兩個 Azure Stack Hub 執行個體上的 Kubernetes：</span><span class="sxs-lookup"><span data-stu-id="cbc14-267">External traffic must be routed through either a Site-to-Site VPN or Azure Stack Hub Public IP addresses to connect Kubernetes on two Azure Stack Hub instances:</span></span>

![內部和之間的叢集流量](media/pattern-highly-available-kubernetes/aks-inter-and-intra-cluster-traffic.png)

<span data-ttu-id="cbc14-269">**Cluster**</span><span class="sxs-lookup"><span data-stu-id="cbc14-269">**Cluster**</span></span>  

<span data-ttu-id="cbc14-270">Kubernetes 叢集不一定需要透過網際網路存取。</span><span class="sxs-lookup"><span data-stu-id="cbc14-270">The Kubernetes cluster doesn't necessarily need to be accessible via the Internet.</span></span> <span data-ttu-id="cbc14-271">相關部分是用來操作叢集的 Kubernetes API，例如，使用 `kubectl`。</span><span class="sxs-lookup"><span data-stu-id="cbc14-271">The relevant part is the Kubernetes API used to operate a cluster, for example, using `kubectl`.</span></span> <span data-ttu-id="cbc14-272">所有操作叢集或在其中部署應用程式和服務的人員都必須可存取 Kubernetes API 端點。</span><span class="sxs-lookup"><span data-stu-id="cbc14-272">The Kubernetes API endpoint must be accessible to everyone who operates the cluster or deploys applications and services on top of it.</span></span> <span data-ttu-id="cbc14-273">本主題將詳細說明[部署 (CI/CD) 考量](#deployment-cicd-considerations)一節中的 DevOps 觀點。</span><span class="sxs-lookup"><span data-stu-id="cbc14-273">This topic is covered in more detail from a DevOps-perspective in the [Deployment (CI/CD) considerations](#deployment-cicd-considerations) section below.</span></span>

<span data-ttu-id="cbc14-274">在叢集層級上，還有一些關於輸出流量的考量：</span><span class="sxs-lookup"><span data-stu-id="cbc14-274">On the cluster level, there are also a few considerations around egress-traffic:</span></span>

- <span data-ttu-id="cbc14-275">節點更新 (適用於 Ubuntu)</span><span class="sxs-lookup"><span data-stu-id="cbc14-275">Node updates (for Ubuntu)</span></span>
- <span data-ttu-id="cbc14-276">監視資料 (傳送至 Azure LogAnalytics)</span><span class="sxs-lookup"><span data-stu-id="cbc14-276">Monitoring data (sent to Azure LogAnalytics)</span></span>
- <span data-ttu-id="cbc14-277">需要輸出流量的其他代理程式 (專屬於每個部署人員的環境)</span><span class="sxs-lookup"><span data-stu-id="cbc14-277">Other agents requiring outbound traffic (specific to each deployer's environment)</span></span>

<span data-ttu-id="cbc14-278">使用 AKS 引擎部署 Kubernetes 叢集之前，請先規劃最終的網路設計。</span><span class="sxs-lookup"><span data-stu-id="cbc14-278">Before you deploy your Kubernetes cluster using AKS Engine, plan for the final networking design.</span></span> <span data-ttu-id="cbc14-279">比起建立專用虛擬網路，將叢集部署到現有的網路可能會更有效率。</span><span class="sxs-lookup"><span data-stu-id="cbc14-279">Instead of creating a dedicated Virtual Network, it may be more efficient to deploy a cluster into an existing network.</span></span> <span data-ttu-id="cbc14-280">例如，您可以利用已在 Azure Stack Hub 環境中設定的現有站對站 VPN 連線。</span><span class="sxs-lookup"><span data-stu-id="cbc14-280">For example, you might leverage an existing Site-to-Site VPN connection already configured in your Azure Stack Hub environment.</span></span>

<span data-ttu-id="cbc14-281">**基礎結構**</span><span class="sxs-lookup"><span data-stu-id="cbc14-281">**Infrastructure**</span></span>  

<span data-ttu-id="cbc14-282">基礎結構是指存取 Azure Stack Hub 管理端點。</span><span class="sxs-lookup"><span data-stu-id="cbc14-282">Infrastructure refers to accessing the Azure Stack Hub management endpoints.</span></span> <span data-ttu-id="cbc14-283">端點包括租用戶和管理員入口網站，以及 Azure Resource Manager 管理員和用戶端點。</span><span class="sxs-lookup"><span data-stu-id="cbc14-283">Endpoints include the tenant and admin portals, and the Azure Resource Manager admin and tenant endpoints.</span></span> <span data-ttu-id="cbc14-284">您需要這些端點才能操作 Azure Stack Hub 及其核心服務。</span><span class="sxs-lookup"><span data-stu-id="cbc14-284">These endpoints are required to operate Azure Stack Hub and its core services.</span></span>

## <a name="data-and-storage-considerations"></a><span data-ttu-id="cbc14-285">資料和儲存體考量</span><span class="sxs-lookup"><span data-stu-id="cbc14-285">Data and storage considerations</span></span>

<span data-ttu-id="cbc14-286">應用程式的兩個執行個體會部署在兩個 Azure Stack Hub 執行個體上的兩個個別 Kubernetes 叢集上。</span><span class="sxs-lookup"><span data-stu-id="cbc14-286">Two instances of our application will be deployed, on two individual Kubernetes clusters, across two Azure Stack Hub instances.</span></span> <span data-ttu-id="cbc14-287">這種設計會要求我們考慮如何複寫和同步兩者之間的資料。</span><span class="sxs-lookup"><span data-stu-id="cbc14-287">This design will require us to consider how to replicate and synchronize data between them.</span></span>

<span data-ttu-id="cbc14-288">我們可透過 Azure 內建功能在雲端內的多個區域之間複寫儲存體。</span><span class="sxs-lookup"><span data-stu-id="cbc14-288">With Azure, we have the built-in capability to replicate storage across multiple regions and zones within the cloud.</span></span> <span data-ttu-id="cbc14-289">目前，Azure Stack Hub 中沒有任何原生方式可跨兩個不同的 Azure Stack Hub 執行個體複寫儲存體，兩個執行個體會形成兩個獨立的雲端，而且沒有完善的方式可將其當做集合來管理。</span><span class="sxs-lookup"><span data-stu-id="cbc14-289">Currently with Azure Stack Hub there are no native ways to replicate storage across two different Azure Stack Hub instances - they form two independent clouds with no overarching way to manage them as a set.</span></span> <span data-ttu-id="cbc14-290">為跨 Azure Stack Hub 執行的應用程式規劃復原功能，一定會迫使您在應用程式設計和部署中考慮這種獨立性。</span><span class="sxs-lookup"><span data-stu-id="cbc14-290">Planning for resiliency of applications running across Azure Stack Hub forces you to consider this independence in your application design and deployments.</span></span>

<span data-ttu-id="cbc14-291">在大多數情況下，AKS 上部署的復原性和高可用性應用程式不需要進行儲存體複寫。</span><span class="sxs-lookup"><span data-stu-id="cbc14-291">In most cases, storage replication won't be necessary for a resilient and highly available application deployed on AKS.</span></span> <span data-ttu-id="cbc14-292">但是，您應該在應用程式設計中考量每個 Azure Stack Hub 執行個體的獨立儲存體。</span><span class="sxs-lookup"><span data-stu-id="cbc14-292">But you should consider independent storage per Azure Stack Hub instance in your application design.</span></span> <span data-ttu-id="cbc14-293">如果此設計是在 Azure Stack Hub 上部署解決方案的顧慮或障礙，Microsoft 合作夥伴可能可藉由提供儲存體附件來解決此問題。</span><span class="sxs-lookup"><span data-stu-id="cbc14-293">If this design is a concern or road block to deploying the solution on Azure Stack Hub, there are possible solutions from Microsoft Partners that provide storage attachments.</span></span> <span data-ttu-id="cbc14-294">儲存體附件可為跨多個 Azure Stack Hub 和 Azure 的儲存體複寫提供解決方案。</span><span class="sxs-lookup"><span data-stu-id="cbc14-294">Storage attachments provide a storage replication solution across multiple Azure Stack Hubs and Azure.</span></span> <span data-ttu-id="cbc14-295">如需詳細資訊，請參閱[合作夥伴解決方案](#partner-solutions)。</span><span class="sxs-lookup"><span data-stu-id="cbc14-295">For more information, see the [Partner solutions](#partner-solutions).</span></span>

<span data-ttu-id="cbc14-296">在我們的架構中，下列層次會列入考量：</span><span class="sxs-lookup"><span data-stu-id="cbc14-296">In our architecture, these layers were considered:</span></span>

<span data-ttu-id="cbc14-297">**設定**</span><span class="sxs-lookup"><span data-stu-id="cbc14-297">**Configuration**</span></span>

<span data-ttu-id="cbc14-298">設定包括 Azure Stack Hub、AKS 引擎和 Kubernetes 叢集本身的設定。</span><span class="sxs-lookup"><span data-stu-id="cbc14-298">Configuration includes the configuration of Azure Stack Hub, AKS Engine, and the Kubernetes cluster itself.</span></span> <span data-ttu-id="cbc14-299">設定應該盡可能自動化，並在 Git 型版本控制系統 (例如 Azure DevOps 或 GitHub) 中儲存為基礎結構即程式碼。</span><span class="sxs-lookup"><span data-stu-id="cbc14-299">The configuration should be automated as much as possible, and stored as Infrastructure-as-Code in a Git-based version control system like Azure DevOps or GitHub.</span></span> <span data-ttu-id="cbc14-300">這些設定無法輕鬆地在多個部署之間同步。</span><span class="sxs-lookup"><span data-stu-id="cbc14-300">These settings cannot easily be synchronized across multiple deployments.</span></span> <span data-ttu-id="cbc14-301">因此，建議您從外部儲存和套用設定，並且使用 DevOps 管線。</span><span class="sxs-lookup"><span data-stu-id="cbc14-301">Therefore we recommend storing and applying configuration from the outside, and using DevOps pipeline.</span></span>

<span data-ttu-id="cbc14-302">**應用程式**</span><span class="sxs-lookup"><span data-stu-id="cbc14-302">**Application**</span></span>

<span data-ttu-id="cbc14-303">應用程式應該儲存在 Git 架構的存放庫中。</span><span class="sxs-lookup"><span data-stu-id="cbc14-303">The application should be stored in a Git-based repository.</span></span> <span data-ttu-id="cbc14-304">每當有新的部署、應用程式變更或災害復原時，都可以使用 Azure Pipelines 輕鬆地進行部署。</span><span class="sxs-lookup"><span data-stu-id="cbc14-304">Whenever there's a new deployment, changes to the application, or disaster recovery, it can be easily deployed using Azure Pipelines.</span></span>

<span data-ttu-id="cbc14-305">**資料**</span><span class="sxs-lookup"><span data-stu-id="cbc14-305">**Data**</span></span>

<span data-ttu-id="cbc14-306">在大部分的應用程式設計中，資料都是最重要的考量。</span><span class="sxs-lookup"><span data-stu-id="cbc14-306">Data is the most important consideration in most application designs.</span></span> <span data-ttu-id="cbc14-307">應用程式資料必須在不同的應用程式執行個體之間保持同步。</span><span class="sxs-lookup"><span data-stu-id="cbc14-307">Application data must stay in sync between the different instances of the application.</span></span> <span data-ttu-id="cbc14-308">如果發生中斷情形，資料也需要備份和災害復原策略。</span><span class="sxs-lookup"><span data-stu-id="cbc14-308">Data also needs a backup and disaster recovery strategy if there's an outage.</span></span>

<span data-ttu-id="cbc14-309">達成這項設計的關鍵在於技術選擇。</span><span class="sxs-lookup"><span data-stu-id="cbc14-309">Achieving this design depends heavily on technology choices.</span></span> <span data-ttu-id="cbc14-310">以下是以高可用性方式在 Azure Stack Hub 上實作資料庫的一些解決方案範例：</span><span class="sxs-lookup"><span data-stu-id="cbc14-310">Here are some solution examples for implementing a database in a highly available fashion on Azure Stack Hub:</span></span>

- [<span data-ttu-id="cbc14-311">將 SQL Server 2016 可用性群組部署至 Azure 和 Azure Stack Hub</span><span class="sxs-lookup"><span data-stu-id="cbc14-311">Deploy a SQL Server 2016 availability group to Azure and Azure Stack Hub</span></span>](/azure-stack/hybrid/solution-deployment-guide-sql-ha)
- [<span data-ttu-id="cbc14-312">將高度可用的 MongoDB 解決方案部署到 Azure 和 Azure Stack Hub</span><span class="sxs-lookup"><span data-stu-id="cbc14-312">Deploy a highly available MongoDB solution to Azure and Azure Stack Hub</span></span>](/azure-stack/hybrid/solution-deployment-guide-mongodb-ha)

<span data-ttu-id="cbc14-313">針對跨多個位置的資料提供高可用性和復原性解決方案是更複雜的考量。</span><span class="sxs-lookup"><span data-stu-id="cbc14-313">Considerations when working with data across multiple locations is an even more complex consideration for a highly available and resilient solution.</span></span> <span data-ttu-id="cbc14-314">考量：</span><span class="sxs-lookup"><span data-stu-id="cbc14-314">Consider:</span></span>

- <span data-ttu-id="cbc14-315">Azure Stack Hub 之間的延遲和網路連線能力。</span><span class="sxs-lookup"><span data-stu-id="cbc14-315">Latency and network connectivity between Azure Stack Hubs.</span></span>
- <span data-ttu-id="cbc14-316">服務和權限的身分識別可用性。</span><span class="sxs-lookup"><span data-stu-id="cbc14-316">Availability of identities for services and permissions.</span></span> <span data-ttu-id="cbc14-317">每個 Azure Stack Hub 執行個體都會與外部目錄整合。</span><span class="sxs-lookup"><span data-stu-id="cbc14-317">Each Azure Stack Hub instance integrates with an external directory.</span></span> <span data-ttu-id="cbc14-318">部署期間，您會選擇 Azure Active Directory (Azure AD) 或 Active Directory 同盟服務 (ADFS)。</span><span class="sxs-lookup"><span data-stu-id="cbc14-318">During deployment, you choose to use either Azure Active Directory (Azure AD) or Active Directory Federation Services (ADFS).</span></span> <span data-ttu-id="cbc14-319">因此，可能會使用可與多個獨立 Azure Stack Hub 執行個體互動的單一身分識別。</span><span class="sxs-lookup"><span data-stu-id="cbc14-319">As such, there's potential to use a single identity that can interact with multiple independent Azure Stack Hub instances.</span></span>

## <a name="business-continuity-and-disaster-recovery"></a><span data-ttu-id="cbc14-320">商務持續性和災害復原</span><span class="sxs-lookup"><span data-stu-id="cbc14-320">Business continuity and disaster recovery</span></span>

<span data-ttu-id="cbc14-321">商務持續性和災害復原 (BCDR) 是 Azure Stack Hub 和 Azure 中的重要主題。</span><span class="sxs-lookup"><span data-stu-id="cbc14-321">Business continuity and disaster recovery (BCDR) is an important topic in both Azure Stack Hub and Azure.</span></span> <span data-ttu-id="cbc14-322">主要差異在於，在 Azure Stack Hub 中，操作員必須管理整個 BCDR 程序。</span><span class="sxs-lookup"><span data-stu-id="cbc14-322">The main difference is that in Azure Stack Hub, the operator must manage the whole BCDR process.</span></span> <span data-ttu-id="cbc14-323">在 Azure 中，BCDR 的某些部分會由 Microsoft 自動管理。</span><span class="sxs-lookup"><span data-stu-id="cbc14-323">In Azure, parts of BCDR are automatically managed by Microsoft.</span></span>

<span data-ttu-id="cbc14-324">BCDR 會影響上一節＜[資料和儲存體考量](#data-and-storage-considerations)＞中所述的相同區域：</span><span class="sxs-lookup"><span data-stu-id="cbc14-324">BCDR affects the same areas mentioned in the previous section [Data and storage considerations](#data-and-storage-considerations):</span></span>

- <span data-ttu-id="cbc14-325">基礎結構/設定</span><span class="sxs-lookup"><span data-stu-id="cbc14-325">Infrastructure / Configuration</span></span>
- <span data-ttu-id="cbc14-326">應用程式可用性</span><span class="sxs-lookup"><span data-stu-id="cbc14-326">Application Availability</span></span>
- <span data-ttu-id="cbc14-327">應用程式資料</span><span class="sxs-lookup"><span data-stu-id="cbc14-327">Application Data</span></span>

<span data-ttu-id="cbc14-328">如上一節所述，這些區域是 Azure Stack Hub 操作員的責任，而且可能會因組織而異。</span><span class="sxs-lookup"><span data-stu-id="cbc14-328">And as mentioned in the previous section, these areas are the responsibility of the Azure Stack Hub operator and can vary between organizations.</span></span> <span data-ttu-id="cbc14-329">根據您可用的工具和程序來規劃 BCDR。</span><span class="sxs-lookup"><span data-stu-id="cbc14-329">Plan BCDR according to your available tools and processes.</span></span>

<span data-ttu-id="cbc14-330">**基礎結構與設定**</span><span class="sxs-lookup"><span data-stu-id="cbc14-330">**Infrastructure and configuration**</span></span>

<span data-ttu-id="cbc14-331">本節涵蓋 Azure Stack Hub 的實體和邏輯基礎結構及設定。</span><span class="sxs-lookup"><span data-stu-id="cbc14-331">This section covers the physical and logical infrastructure and the configuration of Azure Stack Hub.</span></span> <span data-ttu-id="cbc14-332">其中涵蓋管理員和租用戶空間中的動作。</span><span class="sxs-lookup"><span data-stu-id="cbc14-332">It covers actions in the admin and the tenant spaces.</span></span>

<span data-ttu-id="cbc14-333">Azure Stack Hub 操作員 (或管理員) 需負責維護 Azure Stack Hub 執行個體。</span><span class="sxs-lookup"><span data-stu-id="cbc14-333">The Azure Stack Hub operator (or administrator) is responsible for maintenance of the Azure Stack Hub instances.</span></span> <span data-ttu-id="cbc14-334">包括網路、儲存體、身分識別等元件，以及本文範圍以外的其他主題。</span><span class="sxs-lookup"><span data-stu-id="cbc14-334">Including components such as the network, storage, identity, and other topics that are outside the scope of this article.</span></span> <span data-ttu-id="cbc14-335">若要深入了解 Azure Stack Hub 作業的詳細資訊，請參閱下列資源：</span><span class="sxs-lookup"><span data-stu-id="cbc14-335">To learn more about the specifics of Azure Stack Hub operations, see the following resources:</span></span>

- [<span data-ttu-id="cbc14-336">使用基礎結構備份服務來復原 Azure Stack Hub 中的資料</span><span class="sxs-lookup"><span data-stu-id="cbc14-336">Recover data in Azure Stack Hub with the Infrastructure Backup Service</span></span>](/azure-stack/operator/azure-stack-backup-infrastructure-backup)
- [<span data-ttu-id="cbc14-337">從系統管理員入口網站啟用 Azure Stack Hub 的備份</span><span class="sxs-lookup"><span data-stu-id="cbc14-337">Enable backup for Azure Stack Hub from the administrator portal</span></span>](/azure-stack/operator/azure-stack-backup-enable-backup-console)
- [<span data-ttu-id="cbc14-338">從重大資料遺失的情況下復原</span><span class="sxs-lookup"><span data-stu-id="cbc14-338">Recover from catastrophic data loss</span></span>](/azure-stack/operator/azure-stack-backup-recover-data)
- [<span data-ttu-id="cbc14-339">基礎結構備份服務的最佳做法</span><span class="sxs-lookup"><span data-stu-id="cbc14-339">Infrastructure Backup Service best practices</span></span>](/azure-stack/operator/azure-stack-backup-best-practices)

<span data-ttu-id="cbc14-340">Azure Stack Hub 是將用來部署 Kubernetes 應用程式的平台和網狀架構。</span><span class="sxs-lookup"><span data-stu-id="cbc14-340">Azure Stack Hub is the platform and fabric on which Kubernetes applications will be deployed.</span></span> <span data-ttu-id="cbc14-341">Kubernetes 應用程式的應用程式擁有者將是 Azure Stack Hub 的使用者，並且有權部署解決方案所需的應用程式基礎結構。</span><span class="sxs-lookup"><span data-stu-id="cbc14-341">The application owner for the Kubernetes application will be a user of Azure Stack Hub, with access granted to deploy the application infrastructure needed for the solution.</span></span> <span data-ttu-id="cbc14-342">在此情況下，應用程式基礎結構即代表使用 AKS 引擎部署的 Kubernetes 叢集及周圍的服務。</span><span class="sxs-lookup"><span data-stu-id="cbc14-342">Application infrastructure in this case means the Kubernetes cluster, deployed using AKS Engine, and the surrounding services.</span></span> <span data-ttu-id="cbc14-343">這些元件將會部署到 Azure Stack Hub，並受到 Azure Stack Hub 供應項目的限制。</span><span class="sxs-lookup"><span data-stu-id="cbc14-343">These components will be deployed into Azure Stack Hub, constrained by an Azure Stack Hub offer.</span></span> <span data-ttu-id="cbc14-344">請確定 Kubernetes 應用程式擁有者所接受的供應項目有足夠的容量 (以 Azure Stack Hub 配額表示)，可部署整個解決方案。</span><span class="sxs-lookup"><span data-stu-id="cbc14-344">Make sure the offer accepted by the Kubernetes application owner has sufficient capacity (expressed in Azure Stack Hub quotas) to deploy the entire solution.</span></span> <span data-ttu-id="cbc14-345">如前一節所建議，應用程式部署應該使用基礎結構即程式碼和部署管線 (如 Azure DevOps Azure Pipelines) 來自動化。</span><span class="sxs-lookup"><span data-stu-id="cbc14-345">As recommended in the previous section, the application deployment should be automated using Infrastructure-as-Code and deployment pipelines like Azure DevOps Azure Pipelines.</span></span>

<span data-ttu-id="cbc14-346">如需有關 Azure Stack Hub 供應項目和配額的詳細資訊，請參閱 [Azure Stack Hub 服務、方案、供應項目和訂用帳戶概觀](/azure-stack/operator/service-plan-offer-subscription-overview)</span><span class="sxs-lookup"><span data-stu-id="cbc14-346">For more information on Azure Stack Hub offers and quotas, see [Azure Stack Hub services, plans, offers, and subscriptions overview](/azure-stack/operator/service-plan-offer-subscription-overview)</span></span>

<span data-ttu-id="cbc14-347">請務必安全地儲存 AKS 引擎設定，包括其輸出。</span><span class="sxs-lookup"><span data-stu-id="cbc14-347">It's important to securely save and store the AKS Engine configuration including its outputs.</span></span> <span data-ttu-id="cbc14-348">這些檔案包含用來存取 Kubernetes 叢集的機密資訊，因此必須受到保護，以免公開給非管理員知道。</span><span class="sxs-lookup"><span data-stu-id="cbc14-348">These files contain confidential information used to access the Kubernetes cluster, so it must be protected from being exposed to non-administrators.</span></span>

<span data-ttu-id="cbc14-349">**應用程式可用性**</span><span class="sxs-lookup"><span data-stu-id="cbc14-349">**Application availability**</span></span>

<span data-ttu-id="cbc14-350">應用程式不應該依賴已部署執行個體的備份。</span><span class="sxs-lookup"><span data-stu-id="cbc14-350">The application shouldn't rely on backups of a deployed instance.</span></span> <span data-ttu-id="cbc14-351">標準做法應是遵循基礎結構即程式碼模式，來完全重新部署應用程式。</span><span class="sxs-lookup"><span data-stu-id="cbc14-351">As a standard practice, redeploy the application completely following Infrastructure-as-Code patterns.</span></span> <span data-ttu-id="cbc14-352">例如，使用 Azure DevOps Azure Pipelines 重新部署。</span><span class="sxs-lookup"><span data-stu-id="cbc14-352">For example, redeploy using Azure DevOps Azure Pipelines.</span></span> <span data-ttu-id="cbc14-353">BCDR 程序應該牽涉到將應用程式重新部署到相同或另一個 Kubernetes 叢集。</span><span class="sxs-lookup"><span data-stu-id="cbc14-353">The BCDR procedure should involve the redeployment of the application to the same or another Kubernetes cluster.</span></span>

<span data-ttu-id="cbc14-354">**應用程式資料**</span><span class="sxs-lookup"><span data-stu-id="cbc14-354">**Application data**</span></span>

<span data-ttu-id="cbc14-355">應用程式資料，是將資料遺失機率降到最低的重要部分。</span><span class="sxs-lookup"><span data-stu-id="cbc14-355">Application data is the critical part to minimize data loss.</span></span> <span data-ttu-id="cbc14-356">在上一節中，我們已說明在應用程式的兩個 (或多個) 執行個體之間複寫和同步資料的技術。</span><span class="sxs-lookup"><span data-stu-id="cbc14-356">In the previous section, techniques to replicate and synchronize data between two (or more) instances of the application were described.</span></span> <span data-ttu-id="cbc14-357">由於儲存資料的資料庫基礎結構不同 (MySQL、MongoDB、MSSQL 或其他)，因此也會有不同的資料庫可用性和備份技術可供選擇。</span><span class="sxs-lookup"><span data-stu-id="cbc14-357">Depending on the database infrastructure (MySQL, MongoDB, MSSQL or others) used to store the data, there will be different database availability and backup techniques available to choose from.</span></span>

<span data-ttu-id="cbc14-358">若要達到完整性，建議使用下列其中一個方法：</span><span class="sxs-lookup"><span data-stu-id="cbc14-358">The recommended ways to achieve integrity are to use either:</span></span>
- <span data-ttu-id="cbc14-359">適用於特定資料庫的原生備份方案。</span><span class="sxs-lookup"><span data-stu-id="cbc14-359">A native backup solution for the specific database.</span></span>
- <span data-ttu-id="cbc14-360">正式支援備份和復原您應用程式所用資料庫類型的備份解決方案。</span><span class="sxs-lookup"><span data-stu-id="cbc14-360">A backup solution that officially supports backup and recovery of the database type used by your application.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="cbc14-361">請勿將您的備份資料儲存在應用程式資料所在的相同 Azure Stack Hub 執行個體上。</span><span class="sxs-lookup"><span data-stu-id="cbc14-361">Do not store your backup data on the same Azure Stack Hub instance where your application data resides.</span></span> <span data-ttu-id="cbc14-362">若 Azure Stack Hub 執行個體完全中斷，也會危害您的備份。</span><span class="sxs-lookup"><span data-stu-id="cbc14-362">A complete outage of the Azure Stack Hub instance would also compromise your backups.</span></span>

## <a name="availability-considerations"></a><span data-ttu-id="cbc14-363">可用性考量</span><span class="sxs-lookup"><span data-stu-id="cbc14-363">Availability considerations</span></span>

<span data-ttu-id="cbc14-364">透過 AKS 引擎部署在 Azure Stack Hub 上的 Kubernetes 不是受控服務。</span><span class="sxs-lookup"><span data-stu-id="cbc14-364">Kubernetes on Azure Stack Hub deployed via AKS Engine isn't a managed service.</span></span> <span data-ttu-id="cbc14-365">這是使用 Azure 基礎結構即服務 (IaaS) 的自動 Kubernetes 叢集部署和設定。</span><span class="sxs-lookup"><span data-stu-id="cbc14-365">It's an automated deployment and configuration of a Kubernetes cluster using Azure Infrastructure-as-a-Service (IaaS).</span></span> <span data-ttu-id="cbc14-366">因此，其提供與基礎結構相同的可用性。</span><span class="sxs-lookup"><span data-stu-id="cbc14-366">As such, it provides the same availability as the underlying infrastructure.</span></span>

<span data-ttu-id="cbc14-367">Azure Stack Hub 基礎結構已具備失敗復原能力，並提供可用性設定組之類的功能，將元件分散到多個[容錯和更新網域](/azure-stack/user/azure-stack-vm-considerations#high-availability)。</span><span class="sxs-lookup"><span data-stu-id="cbc14-367">Azure Stack Hub infrastructure is already resilient to failures, and provides capabilities like Availability Sets to distribute components across multiple [fault and update domains](/azure-stack/user/azure-stack-vm-considerations#high-availability).</span></span> <span data-ttu-id="cbc14-368">但在發生硬體失敗時，基礎技術 (容錯移轉叢集) 仍然會造成受影響實體伺服器上的 VM 產生一些停機時間。</span><span class="sxs-lookup"><span data-stu-id="cbc14-368">But the underlying technology (failover clustering) still incurs some downtime for VMs on an impacted physical server, if there's a hardware failure.</span></span>

<span data-ttu-id="cbc14-369">將實際執行的 Kubernetes 叢集和工作負載部署至兩個 (或多個) 叢集是很好的作法。</span><span class="sxs-lookup"><span data-stu-id="cbc14-369">It's a good practice to deploy your production Kubernetes cluster as well as the workload to two (or more) clusters.</span></span> <span data-ttu-id="cbc14-370">這些叢集應裝載於不同的位置或資料中心，並使用 Azure 流量管理員之類的技術，根據叢集回應時間或根據地理位置來路由使用者。</span><span class="sxs-lookup"><span data-stu-id="cbc14-370">These clusters should be hosted in different locations or datacenters, and use technologies like Azure Traffic Manager to route users based on cluster response time or based on geography.</span></span>

![使用流量管理員控制流量](media/pattern-highly-available-kubernetes/aks-azure-traffic-manager.png)

<span data-ttu-id="cbc14-372">具有單一 Kubernetes 叢集的客戶通常會連線至指定應用程式的服務 IP 或 DNS 名稱。</span><span class="sxs-lookup"><span data-stu-id="cbc14-372">Customers who have a single Kubernetes cluster typically connect to the service IP or DNS name of a given application.</span></span> <span data-ttu-id="cbc14-373">在多個叢集的部署中，客戶應該連線至流量管理員 DNS 名稱，而這個名稱會指向每個 Kubernetes 叢集上的服務/輸入。</span><span class="sxs-lookup"><span data-stu-id="cbc14-373">In a multi-cluster deployment, customers should connect to a Traffic Manager DNS name that points to the services/ingress on each Kubernetes cluster.</span></span>

![使用流量管理員路由至內部部署叢集](media/pattern-highly-available-kubernetes/aks-azure-traffic-manager-on-premises.png)

> [!NOTE]
> <span data-ttu-id="cbc14-375">此模式也是 [Azure中適用於 (受控) AKS 叢集的最佳作法](/azure/aks/operator-best-practices-multi-region#plan-for-multiregion-deployment)。</span><span class="sxs-lookup"><span data-stu-id="cbc14-375">This pattern is also a [best practice for (managed) AKS clusters in Azure](/azure/aks/operator-best-practices-multi-region#plan-for-multiregion-deployment).</span></span>

<span data-ttu-id="cbc14-376">透過 AKS 引擎部署的 Kubernetes 叢集本身應包含至少三個主要節點和兩個背景工作節點。</span><span class="sxs-lookup"><span data-stu-id="cbc14-376">The Kubernetes cluster itself, deployed via AKS Engine, should consist of at least three master nodes and two worker nodes.</span></span>

## <a name="identity-and-security-considerations"></a><span data-ttu-id="cbc14-377">身分識別和安全性考量</span><span class="sxs-lookup"><span data-stu-id="cbc14-377">Identity and security considerations</span></span>

<span data-ttu-id="cbc14-378">身分識別和安全性是很重要的主題。</span><span class="sxs-lookup"><span data-stu-id="cbc14-378">Identity and security are important topics.</span></span> <span data-ttu-id="cbc14-379">特別是當解決方案跨越獨立 Azure Stack Hub 執行個體時。</span><span class="sxs-lookup"><span data-stu-id="cbc14-379">Especially when the solution spans independent Azure Stack Hub instances.</span></span> <span data-ttu-id="cbc14-380">Kubernetes 和 Azure (包含 Azure Stack Hub) 均有不同的角色型存取控制 (RBAC) 機制：</span><span class="sxs-lookup"><span data-stu-id="cbc14-380">Kubernetes and Azure (including Azure Stack Hub) both have distinct mechanisms for role-based access control (RBAC):</span></span>

- <span data-ttu-id="cbc14-381">Azure RBAC 會控制 Azure (以及 Azure Stack Hub) 中的資源存取權，包括建立新 Azure 資源的能力。</span><span class="sxs-lookup"><span data-stu-id="cbc14-381">Azure RBAC controls access to resources in Azure (and Azure Stack Hub), including the ability to create new Azure resources.</span></span> <span data-ttu-id="cbc14-382">權限可以指派給使用者、群組或服務主體。</span><span class="sxs-lookup"><span data-stu-id="cbc14-382">Permissions can be assigned to users, groups, or service principals.</span></span> <span data-ttu-id="cbc14-383">(服務主體是由應用程式所使用的安全性身分識別)。</span><span class="sxs-lookup"><span data-stu-id="cbc14-383">(A service principal is a security identity used by applications.)</span></span>
- <span data-ttu-id="cbc14-384">Kubernetes RBAC 會控制 Kubernetes API 的權限。</span><span class="sxs-lookup"><span data-stu-id="cbc14-384">Kubernetes RBAC controls permissions to the Kubernetes API.</span></span> <span data-ttu-id="cbc14-385">例如，建立 Pod 和列出 Pod 都是可透過 RBAC 來允許 (或拒絕) 使用者執行的動作。</span><span class="sxs-lookup"><span data-stu-id="cbc14-385">For example, creating pods and listing pods are actions that can be authorized (or denied) to a user through RBAC.</span></span> <span data-ttu-id="cbc14-386">若要將 Kubernetes 權限指派給使用者，您可以建立「角色」和「角色繫結」。</span><span class="sxs-lookup"><span data-stu-id="cbc14-386">To assign Kubernetes permissions to users, you create roles and role bindings.</span></span>

<span data-ttu-id="cbc14-387">**Azure Stack Hub 身分識別和 RBAC**</span><span class="sxs-lookup"><span data-stu-id="cbc14-387">**Azure Stack Hub identity and RBAC**</span></span>

<span data-ttu-id="cbc14-388">Azure Stack Hub 提供兩個身分識別提供者的選項。</span><span class="sxs-lookup"><span data-stu-id="cbc14-388">Azure Stack Hub provides two identity provider choices.</span></span> <span data-ttu-id="cbc14-389">您所使用的提供者取決於環境，以及是否在已連線或已中斷連線的環境中執行：</span><span class="sxs-lookup"><span data-stu-id="cbc14-389">The provider you use depends on the environment and whether running in a connected or disconnected environment:</span></span>

- <span data-ttu-id="cbc14-390">Azure AD - 只能在已連線的環境中使用。</span><span class="sxs-lookup"><span data-stu-id="cbc14-390">Azure AD - can only be used in a connected environment.</span></span>
- <span data-ttu-id="cbc14-391">傳統 Active Directory 樹系的 ADFS - 可以用於已連線或已中斷連線的環境。</span><span class="sxs-lookup"><span data-stu-id="cbc14-391">ADFS to a traditional Active Directory forest - can be used in both a connected or disconnected environment.</span></span>

<span data-ttu-id="cbc14-392">識別提供者會管理使用者和群組，包括存取資源的驗證和授權。</span><span class="sxs-lookup"><span data-stu-id="cbc14-392">The identity provider manages users and groups, including authentication and authorization for accessing resources.</span></span> <span data-ttu-id="cbc14-393">您可以將存取權授與 Azure Stack Hub 資源，例如訂用帳戶、資源群組和個別資源 (例如 VM 或負載平衡器)。</span><span class="sxs-lookup"><span data-stu-id="cbc14-393">Access can be granted to Azure Stack Hub resources like subscriptions, resource groups, and individual resources like VMs or load balancers.</span></span> <span data-ttu-id="cbc14-394">若要擁有一致的存取模型，您應該考慮對所有 Azure Stack Hub 使用相同群組 (直接或巢狀)。</span><span class="sxs-lookup"><span data-stu-id="cbc14-394">To have a consistent access model, you should consider using the same groups (either direct or nested) for all Azure Stack Hubs.</span></span> <span data-ttu-id="cbc14-395">以下是設定範例：</span><span class="sxs-lookup"><span data-stu-id="cbc14-395">Here's a configuration example:</span></span>

![使用 Azure Stack Hub 的巢狀 AAD 群組](media/pattern-highly-available-kubernetes/azure-stack-azure-ad-nested-groups.png)

<span data-ttu-id="cbc14-397">此範例包含適用於特定用途的專用群組 (使用 AAD 或 ADFS)。</span><span class="sxs-lookup"><span data-stu-id="cbc14-397">The example contains a dedicated group (using AAD or ADFS) for a specific purpose.</span></span> <span data-ttu-id="cbc14-398">例如，針對在特定 Azure Stack Hub 執行個體上包含 Kubernetes 叢集基礎結構的資源群組提供「參與者」權限 (在此為 "Seattle K8s 叢集參與者")。</span><span class="sxs-lookup"><span data-stu-id="cbc14-398">For example, to provide Contributor permissions for the Resource Group that contains our Kubernetes cluster infrastructure on a specific Azure Stack Hub instance (here "Seattle K8s Cluster Contributor").</span></span> <span data-ttu-id="cbc14-399">這些群組接著會進到包含每個 Azure Stack Hub「子群組」的整體群組巢狀架構中。</span><span class="sxs-lookup"><span data-stu-id="cbc14-399">These groups are then nested into an overall group that contains the "subgroups" for each Azure Stack Hub.</span></span>

<span data-ttu-id="cbc14-400">我們的範例使用者現在在包含整組 Kubernetes 基礎結構資源的資源群組上都具有「參與者」權限。</span><span class="sxs-lookup"><span data-stu-id="cbc14-400">Our sample user will now have "Contributor" permissions to both Resources Groups that contain the entire set of Kubernetes infrastructure resources.</span></span> <span data-ttu-id="cbc14-401">因為兩個 Azure Stack Hub 執行個體共用相同的身分識別提供者，所以使用者可以存取這些執行個體上的資源。</span><span class="sxs-lookup"><span data-stu-id="cbc14-401">The user will have access to resources on both Azure Stack Hub instances, because the instances share the same identity provider.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="cbc14-402">這些權限只會影響 Azure Stack Hub 和以其為基礎部署的一些資源。</span><span class="sxs-lookup"><span data-stu-id="cbc14-402">These permissions affect only Azure Stack Hub and some of the resources deployed on top of it.</span></span> <span data-ttu-id="cbc14-403">具有此存取層級的使用者可造成不少傷害，但無法存取 Kubernetes IaaS VM 或 Kubernetes API，除非有額外的 Kubernetes 部署存取權。</span><span class="sxs-lookup"><span data-stu-id="cbc14-403">A user who has this level of access can do a lot of harm, but cannot access the Kubernetes IaaS VMs nor the Kubernetes API without additional access to the Kubernetes deployment.</span></span>

<span data-ttu-id="cbc14-404">**Kubernetes 身分識別與 RBAC**</span><span class="sxs-lookup"><span data-stu-id="cbc14-404">**Kubernetes identity and RBAC**</span></span>

<span data-ttu-id="cbc14-405">根據預設，Kubernetes 叢集不會使用與基礎 Azure Stack Hub 相同的識別提供者。</span><span class="sxs-lookup"><span data-stu-id="cbc14-405">A Kubernetes cluster, by default, doesn't use the same Identity Provider as the underlaying Azure Stack Hub.</span></span> <span data-ttu-id="cbc14-406">裝載 Kubernetes 叢集、主要節點和背景工作角色節點的 VM 會使用部署叢集期間所指定的 SSH 金鑰。</span><span class="sxs-lookup"><span data-stu-id="cbc14-406">The VMs hosting the Kubernetes cluster, the master, and worker nodes, use the SSH Key that is specified during the deployment of the cluster.</span></span> <span data-ttu-id="cbc14-407">您需要此 SSH 金鑰，才能使用 SSH 連線到這些節點。</span><span class="sxs-lookup"><span data-stu-id="cbc14-407">This SSH key is required to connect to these nodes using SSH.</span></span>

<span data-ttu-id="cbc14-408">Kubernetes API (例如，使用 `kubectl` 存取) 也會受到服務帳戶的保護，包含預設的「叢集管理員」服務帳戶。</span><span class="sxs-lookup"><span data-stu-id="cbc14-408">The Kubernetes API (for example, accessed by using `kubectl`) is also protected by service accounts including a default "cluster admin" service account.</span></span> <span data-ttu-id="cbc14-409">此服務帳戶的認證一開始會儲存在 Kubernetes 主要節點上的 `.kube/config` 檔案中。</span><span class="sxs-lookup"><span data-stu-id="cbc14-409">The credentials for this service account are initially stored in the `.kube/config` file on your Kubernetes master nodes.</span></span>

<span data-ttu-id="cbc14-410">**祕密管理和應用程式認證**</span><span class="sxs-lookup"><span data-stu-id="cbc14-410">**Secrets management and application credentials**</span></span>

<span data-ttu-id="cbc14-411">若要儲存連接字串或資料庫認證之類的秘密，則有數個選擇，包括：</span><span class="sxs-lookup"><span data-stu-id="cbc14-411">To store secrets like connection strings or database credentials there are several choices, including:</span></span>

- <span data-ttu-id="cbc14-412">Azure 金鑰保存庫</span><span class="sxs-lookup"><span data-stu-id="cbc14-412">Azure Key Vault</span></span>
- <span data-ttu-id="cbc14-413">Kubernetes 秘密</span><span class="sxs-lookup"><span data-stu-id="cbc14-413">Kubernetes Secrets</span></span>
- <span data-ttu-id="cbc14-414">第三方解決方案，例如 HashiCorp Vault (在 Kubernetes 上執行)</span><span class="sxs-lookup"><span data-stu-id="cbc14-414">3rd-Party solutions like HashiCorp Vault (running on Kubernetes)</span></span>

<span data-ttu-id="cbc14-415">請勿將祕密或認證以純文字方式儲存在設定檔、應用程式代碼或指令碼中。</span><span class="sxs-lookup"><span data-stu-id="cbc14-415">Do not store secrets or credentials in plaintext in your configuration files, application code, or within scripts.</span></span> <span data-ttu-id="cbc14-416">並且不要將其儲存在版本控制系統中。</span><span class="sxs-lookup"><span data-stu-id="cbc14-416">And do not store them in a version control system.</span></span> <span data-ttu-id="cbc14-417">相反地，部署自動化應視需要擷取祕密。</span><span class="sxs-lookup"><span data-stu-id="cbc14-417">Instead, the deployment automation should retrieve the secrets as needed.</span></span>

## <a name="patch-and-update"></a><span data-ttu-id="cbc14-418">修補和更新</span><span class="sxs-lookup"><span data-stu-id="cbc14-418">Patch and update</span></span>

<span data-ttu-id="cbc14-419">Azure Kubernetes Service 中的 **修補和更新 (PNU)** 程序會部分自動化。</span><span class="sxs-lookup"><span data-stu-id="cbc14-419">The **Patch and Update (PNU)** process in Azure Kubernetes Service is partially automated.</span></span> <span data-ttu-id="cbc14-420">Kubernetes 版本升級會以手動方式觸發，而安全性更新會自動套用。</span><span class="sxs-lookup"><span data-stu-id="cbc14-420">Kubernetes version upgrades are triggered manually, while security updates are applied automatically.</span></span> <span data-ttu-id="cbc14-421">這些更新包括 OS 安全性修正或核心更新。</span><span class="sxs-lookup"><span data-stu-id="cbc14-421">These updates can include OS security fixes or kernel updates.</span></span> <span data-ttu-id="cbc14-422">AKS 不會自動重新啟動這些 Linux 節點來完成更新程序。</span><span class="sxs-lookup"><span data-stu-id="cbc14-422">AKS doesn't automatically reboot these Linux nodes to complete the update process.</span></span> 

<span data-ttu-id="cbc14-423">在 Azure Stack Hub 上使用 AKS 引擎部署的 Kubernetes 叢集 PNU 程序並不受管理，而且是叢集操作員的責任。</span><span class="sxs-lookup"><span data-stu-id="cbc14-423">The PNU process for a Kubernetes cluster deployed using AKS Engine on Azure Stack Hub is unmanaged, and is the responsibility of the cluster operator.</span></span> 

<span data-ttu-id="cbc14-424">AKS 引擎可協助進行兩項最重要的工作：</span><span class="sxs-lookup"><span data-stu-id="cbc14-424">AKS Engine helps with the two most important tasks:</span></span>

- [<span data-ttu-id="cbc14-425">升級至較新的 Kubernetes 和基礎 OS 映像版本</span><span class="sxs-lookup"><span data-stu-id="cbc14-425">Upgrade to a newer Kubernetes and base OS image version</span></span>](/azure-stack/user/azure-stack-kubernetes-aks-engine-upgrade#steps-to-upgrade-to-a-newer-kubernetes-version)
- [<span data-ttu-id="cbc14-426">僅升級基礎 OS 映像</span><span class="sxs-lookup"><span data-stu-id="cbc14-426">Upgrade the base OS image only</span></span>](/azure-stack/user/azure-stack-kubernetes-aks-engine-upgrade#steps-to-only-upgrade-the-os-image)

<span data-ttu-id="cbc14-427">較新的基礎 OS 映像包含最新的 OS 安全性修正和核心更新。</span><span class="sxs-lookup"><span data-stu-id="cbc14-427">Newer base OS images contain the latest OS security fixes and kernel updates.</span></span> 

<span data-ttu-id="cbc14-428">[自動升級](https://wiki.debian.org/UnattendedUpgrades)機制會自動安裝安全性更新，此更新會在 Azure Stack Hub Marketplace 中有新的基礎 OS 映像版本可用之前發行。</span><span class="sxs-lookup"><span data-stu-id="cbc14-428">The [Unattended Upgrade](https://wiki.debian.org/UnattendedUpgrades) mechanism automatically installs security updates that are released before a new base OS image version is available in the Azure Stack Hub Marketplace.</span></span> <span data-ttu-id="cbc14-429">自動升級會預設為啟用，而且會自動安裝安全性更新，但不會重新啟動 Kubernetes 叢集節點。</span><span class="sxs-lookup"><span data-stu-id="cbc14-429">Unattended upgrade is enabled by default and installs security updates automatically, but does not reboot the Kubernetes cluster nodes.</span></span> <span data-ttu-id="cbc14-430">您可以使用開放原始碼的 [**K** Ubernetes **RE** boot **D** aemon (kured)](/azure/aks/node-updates-kured) 來重新啟動節點。</span><span class="sxs-lookup"><span data-stu-id="cbc14-430">Rebooting the nodes can be automated using the open-source [**K** Ubernetes **RE** boot **D** aemon (kured))](/azure/aks/node-updates-kured).</span></span> <span data-ttu-id="cbc14-431">Kured 會監看需要重新啟動的 Linux 節點，然後自動處理執行中 Pod 和節點重新啟動程序的重新排程。</span><span class="sxs-lookup"><span data-stu-id="cbc14-431">Kured watches for Linux nodes that require a reboot, then automatically handle the rescheduling of running pods and node reboot process.</span></span>

## <a name="deployment-cicd-considerations"></a><span data-ttu-id="cbc14-432">部署 (CI/CD) 考量︰</span><span class="sxs-lookup"><span data-stu-id="cbc14-432">Deployment (CI/CD) considerations</span></span>

<span data-ttu-id="cbc14-433">Azure 和 Azure Stack Hub 會公開相同的 Azure Resource Manager REST API。</span><span class="sxs-lookup"><span data-stu-id="cbc14-433">Azure and Azure Stack Hub expose the same Azure Resource Manager REST APIs.</span></span> <span data-ttu-id="cbc14-434">這些 API 的定址方式與任何其他 Azure 雲端 (Azure、Azure China 21Vianet、Azure Government) 類似。</span><span class="sxs-lookup"><span data-stu-id="cbc14-434">These APIs are addressed like any other Azure cloud (Azure, Azure China 21Vianet, Azure Government).</span></span> <span data-ttu-id="cbc14-435">雲端之間的 API 版本可能會有差異，Azure Stack Hub 只提供服務的子集。</span><span class="sxs-lookup"><span data-stu-id="cbc14-435">There may be differences in API versions between clouds, and Azure Stack Hub provides only a subset of services.</span></span> <span data-ttu-id="cbc14-436">每個雲端和每個 Azure Stack Hub 執行個體的管理端點 URI 也會不同。</span><span class="sxs-lookup"><span data-stu-id="cbc14-436">The management endpoint URI is also different for each cloud, and each instance of Azure Stack Hub.</span></span>

<span data-ttu-id="cbc14-437">除了所述的細微差異之外，Azure Resource Manager REST API 會提供一致的方式來與 Azure 和 Azure Stack Hub 互動。</span><span class="sxs-lookup"><span data-stu-id="cbc14-437">Aside from the subtle differences mentioned, Azure Resource Manager REST APIs provide a consistent way to interact with both Azure and Azure Stack Hub.</span></span> <span data-ttu-id="cbc14-438">在這裡使用的工具組，也可以與任何其他 Azure 雲端搭配使用。</span><span class="sxs-lookup"><span data-stu-id="cbc14-438">The same set of tools can be used here as would be used with any other Azure cloud.</span></span> <span data-ttu-id="cbc14-439">您可以使用 Azure DevOps、Jenkins 之類的工具或 PowerShell，將服務部署至 Azure Stack Hub 並進行協調。</span><span class="sxs-lookup"><span data-stu-id="cbc14-439">You can use Azure DevOps, tools like Jenkins, or PowerShell, to deploy and orchestrate services to Azure Stack Hub.</span></span>

<span data-ttu-id="cbc14-440">**考量**</span><span class="sxs-lookup"><span data-stu-id="cbc14-440">**Considerations**</span></span>

<span data-ttu-id="cbc14-441">在 Azure Stack Hub 部署方面，其中一項主要的差異是網際網路存取性的問題。</span><span class="sxs-lookup"><span data-stu-id="cbc14-441">One of the major differences when it comes to Azure Stack Hub deployments is the question of Internet accessibility.</span></span> <span data-ttu-id="cbc14-442">網際網路存取性會決定要為您的 CI/CD 作業選取 Microsoft 裝載或自我裝載的組建代理程式。</span><span class="sxs-lookup"><span data-stu-id="cbc14-442">Internet accessibility determines whether to select a Microsoft-hosted or a self-hosted build agent for your CI/CD jobs.</span></span>

<span data-ttu-id="cbc14-443">自我裝載式代理程式可以在 Azure Stack Hub 上執行 (作為 IaaS VM)，或在可存取 Azure Stack Hub 的網路子網路中執行。</span><span class="sxs-lookup"><span data-stu-id="cbc14-443">A self-hosted agent can run on top of Azure Stack Hub (as an IaaS VM) or in a network subnet that can access Azure Stack Hub.</span></span> <span data-ttu-id="cbc14-444">若要深入了解差異，請移至 [Azure Pipelines 代理程式](/azure/devops/pipelines/agents/agents)。</span><span class="sxs-lookup"><span data-stu-id="cbc14-444">Go to [Azure Pipelines agents](/azure/devops/pipelines/agents/agents) to learn more about the differences.</span></span>

<span data-ttu-id="cbc14-445">下圖可協助您決定是否需要自我裝載或 Microsoft 裝載的組建代理程式：</span><span class="sxs-lookup"><span data-stu-id="cbc14-445">The following image helps you to decide if you need a self-hosted or a Microsoft-hosted build agent:</span></span>

![自我裝載組建代理程式的是或否](media/pattern-highly-available-kubernetes/aks-on-stack-self-hosted-build-agents-yes-or-no.png)

- <span data-ttu-id="cbc14-447">Azure Stack Hub 管理端點是否可透過網際網路存取？</span><span class="sxs-lookup"><span data-stu-id="cbc14-447">Are the Azure Stack Hub management endpoints accessible via Internet?</span></span>
  - <span data-ttu-id="cbc14-448">是：我們可以搭配使用 Azure Pipelines 與 Microsoft 裝載的代理程式來連線到 Azure Stack Hub。</span><span class="sxs-lookup"><span data-stu-id="cbc14-448">Yes: We can use Azure Pipelines with Microsoft-hosted agents to connect to Azure Stack Hub.</span></span>
  - <span data-ttu-id="cbc14-449">否：我們需要可連線到 Azure Stack Hub 管理端點的自我裝載式代理程式。</span><span class="sxs-lookup"><span data-stu-id="cbc14-449">No: We need self-hosted agents that can connect to Azure Stack Hub's management endpoints.</span></span>
- <span data-ttu-id="cbc14-450">我們的 Kubernetes 叢集是否可透過網際網路存取？</span><span class="sxs-lookup"><span data-stu-id="cbc14-450">Is our Kubernetes cluster accessible via the Internet?</span></span>
  - <span data-ttu-id="cbc14-451">是：我們可以搭配使用 Azure Pipelines 與 Microsoft 裝載的代理程式來直接與 Kubernetes API 端點互動。</span><span class="sxs-lookup"><span data-stu-id="cbc14-451">Yes: We can use Azure Pipelines with Microsoft-hosted agents to interact directly with Kubernetes API endpoint.</span></span>
  - <span data-ttu-id="cbc14-452">否：我們需要可連線到 Kubernetes 叢集 API 端點的自我裝載式代理程式。</span><span class="sxs-lookup"><span data-stu-id="cbc14-452">No: We need self-hosted Agents that can connect to the Kubernetes cluster API endpoint.</span></span>

<span data-ttu-id="cbc14-453">在 Azure Stack Hub 管理端點和 Kubernetes API 可透過網際網路存取的案例中，部署可以使用 Microsoft 裝載的代理程式。</span><span class="sxs-lookup"><span data-stu-id="cbc14-453">In scenarios where the Azure Stack Hub management endpoints and Kubernetes API are accessible via the internet, the deployment can use a Microsoft-hosted agent.</span></span> <span data-ttu-id="cbc14-454">此部署會產生的應用程式架構如下所示：</span><span class="sxs-lookup"><span data-stu-id="cbc14-454">This deployment will result in an application architecture as follows:</span></span>

<span data-ttu-id="cbc14-455">[![公用架構概觀](media/pattern-highly-available-kubernetes/aks-azure-stack-app-pattern.png)](media/pattern-highly-available-kubernetes/aks-azure-stack-app-pattern.png#lightbox)</span><span class="sxs-lookup"><span data-stu-id="cbc14-455">[![Public architecture overview](media/pattern-highly-available-kubernetes/aks-azure-stack-app-pattern.png)](media/pattern-highly-available-kubernetes/aks-azure-stack-app-pattern.png#lightbox)</span></span>

<span data-ttu-id="cbc14-456">如果 Azure Resource Manager 端點、Kubernetes API 或兩者都無法直接透過網際網路存取，我們可以利用自我裝載的組建代理程式來執行管線步驟。</span><span class="sxs-lookup"><span data-stu-id="cbc14-456">If the Azure Resource Manager endpoints, Kubernetes API, or both aren't directly accessible via the Internet, we can leverage a self-hosted build agent to run the pipeline steps.</span></span> <span data-ttu-id="cbc14-457">此設計需要的連線能力比較低，而且只能以內部部署網路到 Azure Resource Manager 端點和 Kubernetes API 的連線進行部署：</span><span class="sxs-lookup"><span data-stu-id="cbc14-457">This design needs less connectivity, and can be deployed with only on-premises network connectivity to Azure Resource Manager endpoints and the Kubernetes API:</span></span>

<span data-ttu-id="cbc14-458">[![內部部署架構概觀](media/pattern-highly-available-kubernetes/aks-azure-stack-app-pattern-self-hosted.png)](media/pattern-highly-available-kubernetes/aks-azure-stack-app-pattern-self-hosted.png#lightbox)</span><span class="sxs-lookup"><span data-stu-id="cbc14-458">[![On-prem architecture overview](media/pattern-highly-available-kubernetes/aks-azure-stack-app-pattern-self-hosted.png)](media/pattern-highly-available-kubernetes/aks-azure-stack-app-pattern-self-hosted.png#lightbox)</span></span>

> [!NOTE]
> <span data-ttu-id="cbc14-459">**那麼中斷連線的情況呢？**</span><span class="sxs-lookup"><span data-stu-id="cbc14-459">**What about disconnected scenarios?**</span></span> <span data-ttu-id="cbc14-460">如果 Azure Stack Hub、Kubernetes 或兩者都沒有向網際網路公開的管理端點，您仍然可以針對您的部署使用 Azure DevOps。</span><span class="sxs-lookup"><span data-stu-id="cbc14-460">In scenarios where either Azure Stack Hub or Kubernetes or both of them do not have internet-facing management endpoints, it is still possible to use Azure DevOps for your deployments.</span></span> <span data-ttu-id="cbc14-461">您可以使用自我裝載的代理程式集區 (在內部部署或 Azure Stack Hub 本身執行的 DevOps 代理程式)，或是完全自我裝載 Azure DevOps Server 內部部署環境。</span><span class="sxs-lookup"><span data-stu-id="cbc14-461">You can either use a self-hosted Agent Pool (which is a DevOps Agent running on-premises or on Azure Stack Hub itself) or a completly self-hosted Azure DevOps Server on-premises.</span></span> <span data-ttu-id="cbc14-462">自我裝載的代理程式只需要輸出的 HTTPS (TCP/443) 網際網路連線。</span><span class="sxs-lookup"><span data-stu-id="cbc14-462">The self-hosted agent needs only outbound HTTPS (TCP/443) Internet connectivity.</span></span>

<span data-ttu-id="cbc14-463">該模式可以在每個 Azure Stack Hub 執行個體上使用 Kubernetes 叢集 (已透過 AKS 引擎部署與協調)。</span><span class="sxs-lookup"><span data-stu-id="cbc14-463">The pattern can use a Kubernetes cluster (deployed and orchestrated with AKS engine) on each Azure Stack Hub instance.</span></span> <span data-ttu-id="cbc14-464">其中包含由前端、中間層、後端服務 (例如 MongoDB) 和以 nginx 為基礎的輸入控制器所組成的應用程式。</span><span class="sxs-lookup"><span data-stu-id="cbc14-464">It includes an application consisting of a frontend, a mid-tier, backend services (for example MongoDB), and an nginx-based Ingress Controller.</span></span> <span data-ttu-id="cbc14-465">您可以利用「外部資料存放區」，而不是使用裝載於 K8s 叢集上的資料庫。</span><span class="sxs-lookup"><span data-stu-id="cbc14-465">Instead of using a database hosted on the K8s cluster, you can leverage "external data stores".</span></span> <span data-ttu-id="cbc14-466">資料庫選項包括 MySQL、SQL Server 或裝載於 Azure Stack Hub 或 IaaS 外部的任何資料庫類型。</span><span class="sxs-lookup"><span data-stu-id="cbc14-466">Database options include MySQL, SQL Server, or any kind of database hosted outside of Azure Stack Hub or in IaaS.</span></span> <span data-ttu-id="cbc14-467">這類設定並不在此範圍內。</span><span class="sxs-lookup"><span data-stu-id="cbc14-467">Configurations like this aren't in scope here.</span></span>

## <a name="partner-solutions"></a><span data-ttu-id="cbc14-468">合作夥伴解決方案</span><span class="sxs-lookup"><span data-stu-id="cbc14-468">Partner solutions</span></span>

<span data-ttu-id="cbc14-469">Microsoft 合作夥伴解決方案可以擴充 Azure Stack Hub 的功能。</span><span class="sxs-lookup"><span data-stu-id="cbc14-469">There are Microsoft Partner solutions that can extend the capabilities of Azure Stack Hub.</span></span> <span data-ttu-id="cbc14-470">這些解決方案在 Kubernetes 叢集上執行的應用程式部署中很有用。</span><span class="sxs-lookup"><span data-stu-id="cbc14-470">These solutions have been found useful in deployments of applications running on Kubernetes clusters.</span></span>  

## <a name="storage-and-data-solutions"></a><span data-ttu-id="cbc14-471">儲存體和資料解決方案</span><span class="sxs-lookup"><span data-stu-id="cbc14-471">Storage and data solutions</span></span>

<span data-ttu-id="cbc14-472">如[資料和儲存體考量](#data-and-storage-considerations)中所述，Azure Stack Hub 目前沒有可跨多個執行個體複寫儲存體的原生解決方案。</span><span class="sxs-lookup"><span data-stu-id="cbc14-472">As described in [Data and storage considerations](#data-and-storage-considerations), Azure Stack Hub currently doesn't have a native solution to replicate storage across multiple instances.</span></span> <span data-ttu-id="cbc14-473">不同於 Azure，跨多個區域複寫儲存體的功能並不存在。</span><span class="sxs-lookup"><span data-stu-id="cbc14-473">Unlike Azure, the capability of replicating storage across multiple regions does not exist.</span></span> <span data-ttu-id="cbc14-474">在 Azure Stack Hub 中，每個執行個體都是各自不同的雲端。</span><span class="sxs-lookup"><span data-stu-id="cbc14-474">In Azure Stack Hub, each instance is its own distinct cloud.</span></span> <span data-ttu-id="cbc14-475">不過，您可以從 Microsoft 合作夥伴取得解決方案，讓您能夠跨 Azure Stack Hub 和 Azure 進行儲存體複寫。</span><span class="sxs-lookup"><span data-stu-id="cbc14-475">However, solutions are available from Microsoft Partners that enable storage replication across Azure Stack Hubs and Azure.</span></span> 

<span data-ttu-id="cbc14-476">**SCALITY**</span><span class="sxs-lookup"><span data-stu-id="cbc14-476">**SCALITY**</span></span>

<span data-ttu-id="cbc14-477">自 2009 起，[Scality](https://www.scality.com/) 即提供具有強大數位商務功能的 Web 規模儲存體。</span><span class="sxs-lookup"><span data-stu-id="cbc14-477">[Scality](https://www.scality.com/) delivers web-scale storage that has powered digital businesses since 2009.</span></span> <span data-ttu-id="cbc14-478">Scality RING 是我們的軟體定義儲存體，可將商用 x86 伺服器轉換為任何資料類型 (檔案及物件) 的無限制存放集區 (以 PB 為單位)。</span><span class="sxs-lookup"><span data-stu-id="cbc14-478">The Scality RING, our software-defined storage, turns commodity x86 servers into an unlimited storage pool for any type of data –file and object– at petabyte scale.</span></span>

<span data-ttu-id="cbc14-479">**CLOUDIAN**</span><span class="sxs-lookup"><span data-stu-id="cbc14-479">**CLOUDIAN**</span></span>

<span data-ttu-id="cbc14-480">[Cloudian](https://www.cloudian.com/) 可利用無限制的可擴充儲存體來簡化企業儲存體，讓大量資料可集合併至單一且易於管理的環境。</span><span class="sxs-lookup"><span data-stu-id="cbc14-480">[Cloudian](https://www.cloudian.com/) simplifies enterprise storage with limitless scalable storage that consolidates massive data sets to a single, easily managed environment.</span></span>

## <a name="next-steps"></a><span data-ttu-id="cbc14-481">後續步驟</span><span class="sxs-lookup"><span data-stu-id="cbc14-481">Next steps</span></span>

<span data-ttu-id="cbc14-482">深入了解此文章介紹的更多相關概念：</span><span class="sxs-lookup"><span data-stu-id="cbc14-482">To learn more about concepts introduced in this article:</span></span>

- <span data-ttu-id="cbc14-483">Azure Stack Hub 中的[跨雲端調整](pattern-cross-cloud-scale.md)及[異地分散式應用程式模式](pattern-geo-distributed.md)。</span><span class="sxs-lookup"><span data-stu-id="cbc14-483">[Cross-cloud scaling](pattern-cross-cloud-scale.md) and [Geo-distributed app patterns](pattern-geo-distributed.md) in Azure Stack Hub.</span></span>
- <span data-ttu-id="cbc14-484">[Azure Kubernetes Service (AKS) 上的微服務架構](/azure/architecture/reference-architectures/microservices/aks)。</span><span class="sxs-lookup"><span data-stu-id="cbc14-484">[Microservices architecture on Azure Kubernetes Service (AKS)](/azure/architecture/reference-architectures/microservices/aks).</span></span>

<span data-ttu-id="cbc14-485">當您準備好要測試解決方案範例時，請繼續前往[高可用性 Kubernetes 叢集部署指南](solution-deployment-guide-highly-available-kubernetes.md)。</span><span class="sxs-lookup"><span data-stu-id="cbc14-485">When you're ready to test the solution example, continue with the [High availability Kubernetes cluster deployment guide](solution-deployment-guide-highly-available-kubernetes.md).</span></span> <span data-ttu-id="cbc14-486">部署指南提供部署及測試其元件的逐步指示。</span><span class="sxs-lookup"><span data-stu-id="cbc14-486">The deployment guide provides step-by-step instructions for deploying and testing its components.</span></span>